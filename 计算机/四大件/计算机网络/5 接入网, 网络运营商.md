# 接入网，网络运营商
>接入网是指用户通过各种技术手段【如光纤、电缆、DSL等】将自己的设备连接到互联网的网络

>网络运营商是提供互联网接入和通信服务的公司或组织

用户通过接入网将自己的设备接入到网络运营商的网络中，从而获取互联网服务
## 准备工作
- 首先，接入路由器会根据PPPoE的发现机制[^14]来寻找运营商端的BAS：
	- 用户询问：”BAS在不在？在的话报告MAC地址“
	- BAS回答：”我在这里，我的MAC地址是xx:xx:xx:xx:xx:xx“
- 接下来，是用户认证阶段
	- 用户名和密码通过***CHAP***[^15]方式发送给BAS
	- 用户名和密码通过***PAP***[^16]方式发送给BAS
- 然后，是BAS向用户下发配置信息[^17]
	- 路由器会根据这些信息配置自身的参数【路由器的BAS端口配置公有地址，路由表中配置默认网关】
- 接下来，互联网接入路由器进行地址转换
	- 如果不使用路由器来上网，BAS下发的配置信息就会直接配置在计算机上【相当于计算机有了公有地址】，这种情况下***无需地址转换***
	- 如果使用路由器来上网，BAS下发的参数就会被配置在路由器上【公有地址是分配给路由器的】。这时，***计算机会被分配一个私有地址，计算机发送的包需要通过路由器进行地址转换然后再转发到互联网中***。有些应用程序【网络电话、聊天、对战游戏等】会因为地址转换无法正常工作【因为有些应用程序需要将自己的IP地址告知通信对象或者告知控制服务器，但在有地址转换的情况下这些操作无法完成】，但现在已经有很多解决方案，因此不能说这些应用程序全都不能正常工作

==一对一连接的端口可以不分配IP地址==【因为网络包不管如何都会被送到另一端】

不用路由器上网会有危险【因为计算机拥有公有地址，这意味着来自互联网的包可以直接到达计算机，这可能导致计算 机被攻击】，因此，对于直接上网的客户端计算机，我们应该采取安装防火 墙软件等防御手段。

>[!faq] ***CHAP***与***PAP***的安全性？
>进行加密的CHAP安全性更高。但是也不是说使用PAP密码就立刻会被窃取。由于明文密码只在运营商端BAS和用户端路由器之间传输【从运营商端BAS向认证服务器发送密码时使用 RADIUS协议，无论用户拨入使用CHAP还是PAP，都是加密的】。
>
>所以如果要窃取密码，就要在路由器和 ADSL Modem 中间进行窃听

[^14]:基于广播来实现
[^15]:挑战握手认证协议
[^16]:密码认证协议
[^17]:配置信息包括分配给上网设备的 IP地址【公有地址】、DNS服务器的IP地址、默认网关的IP地址
## 发送网络包
### 使用ADSL接入网
>ADSL是一种利用架设在电线杆上的金属电话线来进行高速通信的技术

ADSL接入网的上行方向【用户到互联网】和下行方向【互联网到用户】的通信速率是不同的
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=p215RiZm|900]]
- 首先，客户端生成的网络包到达互联网接入路由器后，在此处从以太网包中取出IP包并判断转发目标  ①~④
- 接下来，如果互联网接入路由器和 ADSL Modem 之间是通过以太网连接的，网络包会加上 MAC 头部、PPPoE 头部、PPP 头部总共 3 种头部[^8]，然后按照以太网规则发送出去  ⑤
- 接着，包就到达了 ADSL Modem 后，包会被拆分成很多小格子，每一个小格子称为一个信元【更小一号的包】，并将其转换为电信号  ⑥~⑧
- 然后，电信号会进入一个叫作<u>分离器</u>[^6]的设备与电话的语音信号混合起来
- 之后，从分离器出来，会通过室内电话线，然后到达外部电话线
- 接下来，信号会进入电线杆上架设的电话电缆【如果在电话局附近，电话电缆是埋在地下的】信号通过电话线到达电话局之后，会经过配线盘、分离器到达 DSLAM【多个 ADSL Modem 整合在一个外壳里的设备】
- ***DSLAM 会把电信号还原成信元，并发送给BAS***[^7]  ⑨~⑩
- 之后，BAS 将接收到的 ATM信元 还原成原始的网络包  ⑪~⑫
- 接下来，它会将收到的包前面的 MAC头部 和 PPPoE头部 丢弃，取出 PPP头部以及后面的数据  ⑬
- 接着，BAS 会在包的前面加上隧道专用头部，发送到隧道的出口  ⑭
- 然后，网络包到达隧道出口的隧道专用路由器后，会丢弃隧道头部，取出IP包，并被转发到互联网内部  ⑮~⑰

[^6]:分离器的作用是在信号从电话线传入的时候，负责将 电话 和 ADSL的信号 进行分离
[^7]:BAS：包转发设备
[^8]:MAC头部 和 PPPoE头部 的作用就是将包送达 BAS 的接口

![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=KVDJHycr|900]]
### 使用FTTH
>FTTH是一种宽带接入技术，叫作“光纤到户”

数字信息需要先转换成电信号，再转换成光信号【`1`为高电压表示发光，`0`为低电压表示发暗，将这样的电信号输入LED、激光二极管等光源后，它们就会根据电压的变化发光】

FTTH有直连和分路两种形态
#### 使用直连
>用一根光纤直接从用户端连接到最近的电话局，***通过不同的波长来区分上行/下行光信号***

![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=dSKmYsXg|900]]
- 首先，用户端的光纤收发器将以太网的电信号转换成光信号
- 接下来，光信号通过光纤直接到达<u>BAS</u>前面的多路光纤收发器
- 然后，多路光纤收发器将光信号-->电信号，BAS的端口接收之后，发送进隧道
- 经过运营商的网络后，到达互联网内部
#### 使用分路
>在用户附近的电线杆上安装***分光器***让光纤分路，同时连接多个用户

部分设备与直连不同，大体过程相同
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=bzD79j7s|900]]
***用户端使用的ONU***：
- 可以将电信号转换成光信号
- 可以和电话局的OLT相互配合避免信号碰撞

终端盒 是<u>光纤收发器</u>和<u>ONU</u>等光纤终端设备的统称
## 网络包到达互联网的入口
网络包通过接入网，到达了网络运营商POP的路由器【这里是互联网的入口，网络包会从这里进入互联网内部】
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=xKf3pd00|540]]
## 网络包进入互联网
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=VMTBpvbT|520]]

>***NOC与POP：***
>NOC[^18]是运营商的核心设备，从POP[^19]传来的网络包都会集中到这里，并在这里被转发到离目的地更近的POP，或者是转发到其他的运营商。
>
>***NOC就是规模扩大后的POP***，NOC和POP没有非常严格的界定，NOC里面也可以配备连接接入网的路由器，很多情况下是和POP共用的

>[!question] POP与NOC是怎样连接的？
>由于运营商的网络中需要传输大量的包，已经超过了一般公司使用的双绞线能够容纳的极限，所以运营商一般使用***光纤***来连接POP与NOC
>
>>光纤需要在地下铺设，需要很大的工程费用，而且当线路发生中断时维护工作也需要费用。因此，只有有限的几家大型运营商才拥有光纤。而拥有光纤的公司一般都会提供光纤租用服务【通信线路服务】，其他运营商只要从拥有光纤的公司租借光纤就可以了

[^18]:网络运行中心
[^19]:“Point of Presense” 接入点
## 网络包跨运营商被转发
首先，如果最终目的地【某个Web服务器】和客户端是连接在同一个运营商中的，那么POP路由器根据路由表中的信息判断转发给<u>哪一个NOC/相邻的POP</u>，然后下一个路由器也同样 根据自己路由表中的信息继续转发。经过几次转发之后，网络包就到达了目的地所在的POP路由器

如果服务器的运营商和客户端的运营商不同，网络包需要先发到服务器所在的运营商，这些信息也可以在路由表中找到。这时网络包会被转发到对方运营商的路由器。

