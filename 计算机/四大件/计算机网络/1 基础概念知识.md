# 网络的全貌
浏览器和Web服务器之间的交互却很简单，概括如下：
(1)浏览器向Web服务器发送请求；
(2)Web服务器根据请求向浏览器发送响应；

要实现应用程序之间的交互，我们需要一个能够在浏览器和Web服务器之间传递请求和响应的机制。网络是由很多计算机等设备相互连接组成的，因此在通信的过程中需要确定正确的通信对象，并将请求和响应发送给它们。请求和响应在传递的过程中可能会丢失或损坏【请求和响应本质都是电信号和光信号，这些信号可能会因收到杂音等干扰而损坏】。所以需要一种机制，无论遇到任何情况都能够将请求和响应准确无误地发送给对方。
这种机制是由操作系统中的网络控制软件，以及交换机、路由器等设备分工合作来实现的，它的基本思路是将数字信息分割成一个一个的小块，然后装入一些被称为“包”(Packet)的容器中来运送。大家可以这样理解：包相当于信件或者包裹，而交换机和路由器则相当于邮局或快递公司的分拣处理区。包的头部存有目的地等控制信息，通过许多交换机和路由器的接力，就可以根据控制信息对这些包进行分拣，然后将它们一步一步地搬运到目的地。
无论是家庭和公司里的局域网，还是外面的互联网，它们只是在规模上有所不同，基本的机制都是相同的。

前面介绍的这个负责搬运数字信息的机制，再加上浏览器和Web服务器这些网络应用程序，这两部分就组成了网络。

# URL
> 形如“http://”、“ftp://”、“file://”、“mailto://”等开头的链接，所以浏览器是一个具备多种客户端功能的综合性客户端软件，而URL的开头就是告诉浏览器使用其中哪种功能来访问相应的数据

`http://user:password@www.glasscom.com:80/dir/file1.htm`  会包含服务器的域名，文件的路径
`ftp://user:password@ftp.glasscom.com:21/dir/file1.htm`
`file://localhost/c:/path/file1.zip`
`mailto:tone@glasscom.com`  会包含收件人的邮件地址

***URL中还可能包含用户名，密码，端口号等信息***
## URL省略文件名
- `http://www.lab.glasscom.com/dir/`---这种时候服务器就会访问`/dir/index.html`或`/dir/default.htm`
- `http://www.lab.glasscom.com/`---这表示服务器会访问***根目录***
- `http://www.lab.glasscom.com/`---这时会访问服务器根目录下的`index.html`或者`default.htm`文件
## URL的层次结构
通过`.`来分割层级，***越靠右的层级越高***
```
例如 www.nikkeibp.co.jp
jp代表分配给日本这个国家的域，这个域的下一级又有很多域，co就是其中之一；
co代表公司的域，公司有很多公司，nikkeibp就是其中之一；
nikkeibp代表分配给这家公司的域
```
# TCP/IP
>TCP/IP就是由一些小的子网【由集线器连接起来的几台计算机】，通过路由器连接起来组成一个大的网络
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=E5YjsPvZ|540]]
> 发送者发出的消息首先经过子网中的<u>集线器A</u>，转发到距离发送者最近的<u>路由器A</u>上，接着这个<u>路由器A</u>会根据目的地的位置判断要传送的下一个<u>路由器B</u>【传送到下一个子网的<u>集线器B</u>，再到<u>路由器B</u>】……直到到达目的地

***集线器***：按照以太网规则传输包的设备，集线器可以在子网中将网络包传输到下一个路由器
***路由器***：按照IP规则传输包的设备，路由器可以根据目标地址判断下一个路由器的位置
## 地址
### IP地址
>在同一网络下可以唯一标识的标识号，表示***网络号***+***主机号***。例如`10.11.12.13`

但由于网络号和主机号的具体结构是不固定的，所以我们要引入***子网掩码***来区分

>[!faq] 如何解决IP地址不足的问题？
>将公司内网分成***对互联网开放的服务器***【配公有地址（原来的固定地址，可以和互联网直接通信）】和***公司内部设备***【配私有地址（这些地址只能用于内网）】。那么现在A公司的某台服务器和B公司的某台客户端具有相同的IP地址也没关系。
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=fmkubkxZ|500]]
>私有地址的范围：
>10.0.0.0~10.255.255.255；
>172.16.0.0~172.31.255.255；
>192.168.0.0~192.168.255.255
>
### 子网掩码
>子网掩码表示网络号与主机号之间的边界

子网掩码的表示方式：
- 十进制加分隔号`10.11.12.13/255.255.255.0`
- 网络号比特数`10.11.12.13/24`

### MAC地址
-  MAC地址的结构
>MAC地址长48bit。有两种写法：
>- `00-80-C8-2D-82-EA`
>- `00:80:C8:2D:82:EA`

-  如何知道目标的MAC地址？
> ***通过ARP协议查询目标路由器的MAC地址***：在以太网中，会通过广播把包发给连接在以太网中的所有设备。ARP会向所有设备提问“这个IP地址是谁的？请把你的MAC地址告诉我”，如果对方存在则会回应；如果路由表设置不正确，则只能认为对方不存在，包的发送就会失败。
## DNS服务器
>域名服务系统，将IP地址与域名进行关联

### 缓存机制
每次查询IP地址都要从根域服务器开始那就效率太低了，所以DNS服务器里会有缓存，***可以记住之前查询过的域名***，下次查询可以快速响应。由于原本的域名注册信息会改变，这就会导致缓存里的注册信息是错误的，***所以缓存信息是有有效期的***

### DNS与域的关系
一台DNS服务器只能存储一个或者多个完整的域【比如`.com`域底下分了分多个层级，例如`.example`,`.google`等，那么一台DNS服务器只能完整的存储`.example`这个域，不能这台存一点`.example`，另一台又存一点`.example`】，当然全世界也可以只用一台DNS把`.com`这个域全部存了，但是太多了，只能分层
## TCP协议
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=ns2tkUMG|450]]
### 如何建立管道和销毁管道
- 首先服务器先创建***套接字***【管道两端的数据出入口】【创建套接字后，协议栈会返回描述符（”号码牌“），因为浏览器可能要打开多个网页，所以也会有多个套接字，描述符用来标识套接字】，之后等待客户端连接管道；之后客户端也创建套接字，然后从该套接字延伸管道，连接到服务器端的套接字上。
- 当数据传送完毕之后，断开管道可以由任何一方发起，之后套接字随之销毁

>[!question] TCP是如何确定对方是否收到信息的？
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=4ZCrpyHv|800]]
### TCP/IP包
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=NjKGz5z2|500]]
***IP头部***：包含自己网卡的IP地址，目的地的IP地址，协议号【包的内容类型】及其他信息
***MAC头部***：包含发送方和接收方的MAC地址，以太类型【IP协议，ARP协议，IPv6协议】

>[!question] 包是如何传输的？
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=N1r8Nq1n|600]]
>1. 网络包中有下一个路由器R1的MAC地址，有目的地服务器S的IP地址；
>2. 首先网络包会经过集线器，集线器通过包中的MAC头部信息，查找以太网表知道这个包该发往哪个路由器；
>3. 传输到<u>路由器R1</u>后根据IP表，知道要发往的下一个路由器的位置，但是为了发过去我们还需要查出下一个<u>路由器R2</u>的MAC地址，然后改写MAC头部；
>4. …………；
>5. 直到送达目的地；
## UDP协议
UDP协议只负责发送包，出错时就收不到对方的回复，应用程序会注意到这个问题，会重新发送一遍数据
### 什么情况下使用UDP协议
- 数据很短，用一个包就能装得下的情况下【因为只有一个包，就不用考虑哪个包未送达了，就算重发也就是重发一个包】。***例如DNS查询***
- 重发数据也没什么意义时。***例如发送音频和视频数据时***【因为音频和视频必须在短时间内送达，不然会引起卡顿掉帧，而TCP协议繁琐的传输流程不合适，而且音频和视频缺少某些包一般可以接受】

==当需要穿越防火墙传输音频和视频数据时，我们有时会使用TCP协议【因为UDP经常会被防火墙阻止】==
## 以太网
>以太网是一种为多台计算机能够彼此自由和廉价地互相通信而设计的通信技术

***IP协议本身没有传输包的功能，包的实际传输要委托以太网来完成***
### 以太网的进化历史
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=qaHryAp7]]
>- [ ] (a)
>	***当一台计算机发送信号时，信号会通过网线流过整个网络，最终到达所有的设备***
>	收发器：将不同网线之间的信号连接起来
>
>- [ ] (b)
> 后来(a)变成了(b)，(b)的信号依旧会发送给所有设备，但是将主干网线-->中继式集线器【集线器】，将收发器网线-->双绞线
> 
>- [ ] (c)
>   交换式集线器被称为***交换机***
### 以太网的特点
- [ ] 自动协商：确定最优的传输速率
>当两台设备通电并完成硬件初始化之后，就会开始用脉冲信号发送自己支持的速率【木桶效应】和工作模式【全/半双工】
## 局域网LAN
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=bCkH68Rs]]
## 设备
### 网卡
>***网卡***可能是<u>计算机主板上的板卡</u>，<u>笔记本上的PCMCIA卡</u>，或者是<u>计算机主板上集成的芯片</u>

- [ ] 内部结构
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=KlPCtkvx|600]]
### 集线器
现在我们基本不使用集线器了，而是直接将计算机连接到交换机上
### 交换机
>交换机 = 计算机 + 多块网卡 + 开启“混杂模式”【让网卡接收所有的包】+ 安装网络包转发软件

- [ ] 交换机中的MAC表是如何维护的？
>- 当<u>发送方</u>向交换机发送包时，交换机会记录发送方的MAC地址和包进入交换机时的端口号。【***以便以后要向该发送方发送包时，交换机可以快速反应***】
>- MAC表会在一段时间删除一些记录【防止终端设备移动产生问题】

>[!question] 网卡与交换机的区别
>- ***网卡本身具有MAC地址***，***而交换机的端口不具有MAC地址***
>- ***网卡会根据MAC地址核对包是不是发给自己的***，***而交换机则接收所有的包并存放到缓冲区***

>[!question] 集线器与交换机的区别
>- ***交换机具有更好的性能和碰撞管理能力***
>- ***交换机会根据MAC地址将包发送到正确的端口，而不是广播。从而减少了碰撞的可能性***
>- 交换机的端口速度和带宽远高于集线器
### 路由器
>早期路由器 = 计算机 + 路由软件

- 路由器的内部结构
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=c8bABV8y|600]]
> ***转发模块***：负责判断包的转发目的地，类似于==IP模块==
> ***端口模块***：负责包的收发操作，类似于==网卡==

- 路由器的功能
	- *地址转换*：在转发网络包时对<u>IP头部</u>中的 IP地址 和 端口号[^2] 进行改写
		>假设现在要访问Web服务器：
		>- 首先，TCP连接操作的***第一个包***被转发到互联网时，会将发送方IP地址从私有地址改写成公有地址[^3]
		>- 接着，地址转换设备会随机生成一个空闲端口，并改写前私有地址的端口号
		>- 最后，将改写前和改写后的 地址 和 端口号 作为一组对应的记录保存在地址转换设备内部的表中
		>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=OyGYltBf|500]]
	- 包过滤[^4]：在队报进行转发时，根据MAC头部，IP头部，TCP头部的内容，按照事先设置好的规则决定是 转发/丢弃 这个包

[^2]:指的是TCP和UDP的端口号，不是路由器和集线器连接网线的那个端口
[^3]:此处为地址转换设备的互联网接入端口的地址
[^4]:大多数防火墙设备/软件都是利用这一机制来防止非法入侵的

我们的家用路由器已经集成了<u>集线器</u>，<u>交换机</u>的功能

>[!question] 交换机与路由器的区别
>***交换机是基于 以太网 设计的***
>***路由器是基于 IP 设计的***，路由器的每个端口都有<u>MAC地址</u>和<u>IP地址</u>
>==路由器委托交换机传输包==
# 接入网
>接入网是连接 互联网 与 家庭、公司网络 的通信线路。一般家用的接入网方式包括 ADSL，FTTH，CATV，电话线，ISDN等；公司还可能会使用专线

互联网接入路由器 与 以太网路由器 不同，互联网接入路由器是按照接入网规则来发送包的
## BAS
- BAS是加强版的路由器，它有一般路由器没有的功能【身份认证，下发IP地址等配置信息】
- BAS是由RAS发展而来的，一开始叫“B-RAS”，意思是用于宽带网络的RAS
- RAS也是路由器，它是用一台服务器里面装上RAS软件来实现的
## 接入网中使用的PPP和隧道
### 用户认证和配置下发
ADSL 和 FTTH 接入网中，用户和BAS【用户端的】之间都是通过电缆/光纤固定连接的，因此不需要验证用户身份。但是通过用户名和密码，***运营商可以更好地管理用户***，***用户可以根据用户名来切换不同的运营商***。因此，接入运营商在 ADSL 和 FTTH 中会使用 PPPoE[^11]，BAS[^12]【登录操作的窗口】

[^11]:有些运营商不使用PPP，而是使用DHCP
[^12]:这里的BAS是运营商端的
### PPP
> *在使用电话线/ISDN拨号上网时，PPP的工作流程：*
> - 首先，用户向运营商的接入点拨打电话  ①-1
> - 电话接通  ①-2
> - 输入用户名和密码进行登录操作  ②-2
> - 用户名和密码通过 RADIUS协议[^9] 从 RAS[^10] 发送到认证服务器进行校验
> - 确认无误后，认证服务器会返回IP地址等配置信息，并下发给用户  ②-3
> - 用户端的设备根据服务器返回的配置信息，完成收发网络包的准备工作
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=jmpoEsTO|600]]

> *PPP如何传输消息：*
> 将 PPP消息 装进一个包含<u>报头</u>，<u>FCS</u>，<u>信号格式</u>的容器里，然后以 HDLC协议[^13] 发送出去
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=HpDa4Qc9|600]]

[^9]:远程认证拨号用户服务
[^10]:远程访问服务器
[^13]:原本是为在专线中传输网络包而设计的，拨号接入方式对HDLC进行了修正，然后使用
### PPPoE
> PPPoE = PPP + 以太网

由于 ADSL 和 FTTH 不能使用 HDLC ，所以我们用了以太网进行代替
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=pSfebJIu|900]]
>*PPPoE包*
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=5nBXlO7U|540]]
### PPPoA
只有ADSL接入网可以使用PPPoA【因为FTTH不使用<u>ATM信元</u>】
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=iznefzjS|540]]
使用PPPoA时，***需要和BAS收发PPP消息的设备【计算机，路由器】必须和ADSL Modem是一体的***【因为PPPoA没有MAC头部，PPP消息无法通过以太网传输】

一体化的方式主要有以下两种：
- 第一种是将计算机和 ADSL Modem 用 USB 接口连接起来，这样 ADSL Modem 就和计算机成为一体了【最终并没有普及】
- 另一种方式是将 ADSL Modem 和路由器整合成一台设备。【这种方式无法抛开路由器用计算机直接上网】

PPPoA 相比 PPPoE 可以传输更大的包【因为没有PPPoE头部，PPP头】
### 隧道
>隧道就类似于套接字之间建立的TCP连接，只不过这里的套接字是***BAS***

>*基于TCP连接的隧道*
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=3XYAysn0|520]]
>- 首先需要在网络上的两台隧道路由器【有时是服务器】之间建立TCP连接
>- 然后，将连接两端的套接字当作路由器的端口，从这个端口收发数据

>*基于封装的隧道*
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=vbp19H5N|520]]
>将包含头部在内的整个包装入另一个包中传输到另一端【包可以原封不动地到达另一端】
## 接入网中使用的DHCP
>有一些运营商不使用 PPP，他们使用 DHCP协议 从 BAS 向用户端下发 TCP/IP配置信息 【常用于公司】
### 原理
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=GdnbPjgDYIAw-kRXlJBwd]]
- 首先客户端请求配置信息  ①
- 然后DHCP服务器下发配置信息  ②
### 优点
- 不需要像PPP那样需要多个步骤
- 也不需要验证用户名和密码
- 它可以单纯地直接传输以太网包，不需要添加额外的 PPP头部，因此不会占用 MTU

采用 DHCP的运营商使用的 ADSL Modem 不使用信元【使用信元的 PPPoE，PPPoA 方式中，BAS 需要配备比较昂贵的ATM接口】，而是直接将以太网包调制成 ADSL信号，因此没有 ADSL Modem 和路由器无法分离的问题
# 运营商
## IX
### 什么是IX
> 现在的运营商非常多，如果都用(a)方式连接会非常困难，所以我们可以采用(b)方式，设置一个中心设备，来减少线路数量，这个中心设备就称为***IX***【互联网交换中心】
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=wCWZnokp]]

***IX的核心是具有大量高速以太网端口的二层交换机***

***IX交换机和一般的交换机在工作方式上没有区别***
### 各个运营商路由器怎么连接到IX上
- 当运营商NOC和IX位于同一幢大楼里时
>只要从NOC中将光纤延长出来接到IX交换机就可以了【和公司、家庭网络中的路由器与交换机的连接方法是相同的】  ①

- 如果NOC和IX不在同一幢大楼时
>我们可以用通信线路将路由器和交换机连起来，有两种连法：
>- 从路由器延伸出一根通信线路并连接到IX交换机上   ②
>- 另一种是将路由器搬到IX机房里，用通信线路将路由器和NOC连起来，再将路由器连到IX交换机上   ③

- 在数据中心等网络流量集中的地方
>设置IX终端交换机，各运营商的路由器在这里连接到终端交换机上   ④

![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=TySadd0e|540]]
## 运营商之间的路由信息交换
相连的路由器会互相告知路由信息，获得了对方的路由信息，就知道了对方路由器连接的所有网络，将这些信息写入自己的路由表中，就可以向那些网络发送包了。在获得对方的路由信息之后，我们也要将自身的路由信息告知对方【对方也可以将发往我们所在子网的包转发过来】

这个路由信息交换的过程是由路由器自动完成的，这里使用的机制称为BGP【边界网关协议】
### 交换路由信息的两种方式
- 转接：将互联网中的路由全部告知对方
- 非转接/对等：两个运营商之间仅将与各自网络相关的路由信息告知对方
### 与公司网络中自动更新路由表机制的区别
- 公司

>公司中使用的方式是寻找与目的地之间的最短路由，并按照最短路由来转发包【周围的所有路由器都是平等对待的，路由信息是在所有路由器间平等交换】

>[!hint] 公司内部采用这样的方式没问题，但运营商之间就不行
>假设某个运营商拥有一条连接日本和美国的高速线路，那么要访问美国的地址时，可能这条线路是最短路由。如果单纯采用最短路由的方式，那么其他运营商的包就都会走这条线路，那就无法阻止那些没交费的运营商使用这条线路

- 运营商
	- 互联网中可以指定路由交换的对象【路由交换是在特定路由器间一对一进行】。这样一来，运营商就可以只将路由信息提供给那些交了费的运营商，那些没交费的运营商也就无法将网络包发送过来了
	- 在判断路由时，该机制不仅可以判断是否是最短路由，还可以设置其他一些判断因素【例如当某个目的地有多条路由时，可以对每条路由设置优先级】
# 服务器端Web服务器
## 部署地点
### 在公司里部署web服务器
>服务器直接部署在公司网络上，并且可以从互联网直接访问
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=gac88uKm|500]]

这种情况下，网络包通过最近的POP中的路由器，然后接入网，接着服务器端路由器之后，就直接到达服务器

>[!hint] 现在这已经不是主流方式了
>- 因为IP地址不足。这样的方式需要为公司网络中的所有设备都分配各自的公有地址；
>- 因为安全问题。这种方式中，从互联网传来的网络包会无节制地进入服务器；
### 通过防火墙隔离部署
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=yqIc6sgY]]
### 部署在数据中心
> Web服务器可以把服务器放在网络运营商等管理的数据中心里，或者直接租用运营商提供的服务器
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=fkaYIjKO|500]]

- 数据中心是与运营商NOC直接连接的，或者是与运营商之间的枢纽IX直接连接的。因此服务器可以获得很高的访问速度；
- 数据中心一般位于具有抗震结构的大楼内，还具有自主发电设备，具有更高的安全性；
- 数据中心还提供各种附加服务【如服务器工作状态监控、防火墙的配置和运营、非法入侵监控等】

如果数据中心有防火墙，则网络包会先接受防火墙的检查，放行之后再到达服务器
## 平衡负载
### 通过多台服务器平均分配请求
当服务器的访问量上升时，尤其是通过CGI等应用程序动态生成数据的情况下，***增加服务器线路的带宽是有效的***，但由于网络包太多，所以***使用多台服务器来分担负载的方法更有效***

>[!hint] 实现方式 1
>我们通过DNS服务器将客户端发送的请求分配到每台服务器上
>当访问服务器时，客户端需要先向DNS服务器查询服务器的IP地址，如果在DNS服务器中填写多个名称相同的记录，则每次查询时DNS 服务器都会按顺序返回不同的IP地址。这种方式称为***轮询***
>>轮询缺点：
>>- 假如多台Web服务器中有一台有故障，而DNS服务器并不能确认Web服务器是否正常工作，那么DNS服务器还是会返回这台故障的Web服务器
>>- 在通过CGI等方式动态生成网页的情况下，有些操作是要跨多个页面的，如果这期间访问的服务器发生了变化，这个操作就可能无法继续【例如用户的操作需要在多个页面之间进行。如果在用户从第一个页面跳转到第二个页面的过程中，负责处理第一个页面的服务器发生了变化（如负载均衡、服务器故障等），那么用户可能无法顺利地完成操作】

>[!hint] 实现方式 2
>为了避免出现前面的问题，可以使用***负载均衡器***
>首先要用<u>负载均衡器的IP地址</u>代替<u>Web服务器的IP地址</u>注册到DNS服务器上，客户端会认为负载均衡器就是一台Web服务器，并向其发送请求，然后由负载均衡器来判断将请求转发给哪台Web服务器
>>如何判断请求转发给哪台Web服务器？
>>- 如果操作没有跨多个页面，则可以根据Web服务器的负载状况来进行判断
>>	- 负载均衡器可以定期采集Web服务器的<u>CPU、内存使用率</u>；
>>	- 向Web服务器发送测试包，根据响应所需的时间来判断负载状况【***Web服务器的负载可能会在短时间内上下波动，因此无法非常准确地把握负载状况***；***如果过于密集地去查询服务器的负载，这个查询操作本身就会增加Web服务器的负载***】
>>	- 根据事先设置的服务器性能指数，按比例来分配请求；
>>- 当操作跨多个页面时，必须将请求发送到同一台Web服务器上。由于每一次HTTP访问都是相互独立的，无法判断是否和之前的请求相关[^21]，于是，人们提出了一些方案来判断请求之间的相关性：
>>	- 在发送表单数据时在里面加上用来表示关联的信息
>>	- 对HTTP规格进行扩展，在HTTP头部字段中加上用来判断相关性的信息【Cookie】。这样，负载均衡器就可以通过这些信息来作出判断，将一系列相关的请求发送到同一台Web服务器，对于不相关的请求则发送到负载较低的服务器了

[^21]:因为Web服务器最早并不是用来运行CGI程序的，而是主要用来提供静态文件的，因此HTTP规格就有意省略了请求之间相关性的判断
### 通过缓存服务器
>缓存服务器是一台通过<u>代理机制</u>[^22]对数据进行缓存的服务器。它可以将Web服务器返回的数据保存在磁盘中，并可以代替Web服务器将磁盘中的数据返回给客户端

- ***如果在缓存了数据之后，Web服务器更新了数据，那么缓存的数据将无法使用***
- ***CGI程序等产生的页面数据每次都不同，这些数据也无法缓存***[^30]

[^22]:代理介于Web服务器和客户端之间，其基本原理就是在客户端和Web服务器之间充当中间人
[^30]:这种情况下，我们可以不保存整个页面，而是将每次内容都会发生变化的动态部分，与内容不会发生变化的静态部分分开，只将静态部分保存在缓存中

>[!hint] 缓存服务器的两种代理机制
>***正向代理：***
>>正向代理：代理服务器[^23]***代表客户端***与目标服务器通信[^24]，客户端知道目标服务器的存在，但目标服务器不知道客户端的存在
>
>使用正向代理时，一般需要在浏览器的设置窗口中的“代理服务器”一栏中填写<u>正向代理的IP地址</u>，当设置了正向代理后，浏览器会忽略网址栏的内容，直接将所有请求发送给正向代理。浏览器会在请求的URI字段中填写完整的`http://... 网址`，因此可以根据这个网址来转发【没有正向代理时，浏览器会从网址中提取出Web服务器域名后面的文件名或目录名，然后将其作为请求的URI进行发送，而不是完整的网址】
>
>- 正向代理可用于缓存【代理出现于ADSL、FTTH等技术实用化之前，那时还没有廉价高速的接入网，而代理的缓存功能可以有效利用低速接入网】
>	![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=YrdxEhBO]]
>- 正向代理还可以用来实现防火墙【由于代理在转发过程中可以查看请求的内容，所以可以根据内容判断是否允许访问】
>- 还常应用于绕过网络限制，访问被封锁的网站
>- 提供匿名性，隐藏客户端的真实身份
>
>- 当使用正向代理时【缓存服务器放在服务器端】，无法减少互联网中的流量
>- 客户端的缓存服务器是归客户端网络运营管理者所有的，Web服务器的运营者无法控制它【比如，网站的运营者觉得最近网站上增加了很多大容量的内容，想要增加缓存服务器的容量，但对于放在客户端的缓存就无能为力了】
>
>***反向代理：***
>>反向代理：代理服务器***代表目标服务器***与客户端通信[^25]，客户端知道代理服务器的存在，但不知道目标服务器的存在
>
>正向代理需要在浏览器设置正向代理的IP地址，这样***太麻烦***，而反向代理通过将请求消息中的URI的目录名与Web服务器进行关联，使得代理能够转发一般的不包含完整网址的请求消息
>
>- 常应用于负载均衡
>- 提供高可用性和容错机制【例如当某个后端服务器故障时，请求可以自动切换到其他正常的服务器】
>- 提供安全性【隐藏后端服务器的真实IP地址和细节】
>- 如果使用反向代理【在客户端部署缓存服务器】，就能够减少对Web服务器的访问【因为缓存服务器中有资源，就能减少通过互联网中的拥塞点】
>
>***透明代理***
>>透明代理：把透明代理服务器放在请求消息从浏览器传输到Web服务器的<u>必经之路</u>上，当消息经过时进行拦截[^27]
>
>透明代理不需要设置在浏览器中，所以浏览器还是照常向Web服务器发送请求消息
>必经之路可以是连接互联网的接入网，当用户发送一个网络请求时，请求首先到达透明代理服务器，透明代理服务器会检查请求内容，并根据规则判断是将请求转发到目标服务器[^28]，还是直接从缓存中返回响应
>
>- 常用于缓存
>- 网络访问控制
>- 安全策略实施
>
>==透明代理结合了正向代理和反向代理的优点==，用户不会察觉到代理的存在，也不会注意到HTTP消息是如何被转发的，所以叫“透明代理”

[^23]:此处为缓存服务器
[^24]:正向代理时代理服务器部署在客户端一侧
[^25]:代理服务器部署在目标服务器一侧
[^27]:如果请求消息有多条路径可以到达Web服务器，那么就必须在这些路径上都放置透明代理，因此一般是将网络设计成只有一条路可以走的结构，然后在这一条路径上放置透明代理
[^28]:请求消息中有包头部，包的IP头部中包含接收方IP地址【另外HTTP 1.1中也有一个用于表示访问目标Web服务器的`Host字段`，也可用于判断转发目标】

>[!hint] 如何找到最近的缓存服务器【两种办法】
> 在使用内容分发服务时，一个网站的资源可能分布在多台缓存服务器上
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=xYtR9l01]]
> 
> ***用DNS服务器来分配访问***：
> 1. 首先，需要事先从缓存服务器部署地点的路由器收集路由信息【例如，有4台缓存服务器，在这4台服务器的部署地点又分别有4台路由器，则我们需要分别获取这4台路由器的路由表，并将4张路由表集中到服务器端DNS服务器上】
> 2. 接下来，服务器端DNS服务器根据路由表和客户端DNS服务器发送过来的查询消息【客户端要查询服务器端的IP地址，所以客户端的DNS服务器发送查询消息给服务器端的DNS服务器】，大致判断路径信息
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=TOPpuXFp|900]]
> 
> ***通过重定向服务器分配访问目标***：
>> HTTP规格中有一个`Location字段`。它的意思是“您要访问的数据在另一台服务器上，请访问那台服务器吧”，这种将客户端访问引导到另一台Web服务器的操作称为***重定向***
>
> 1. 首先，在DNS服务器上注册重定向服务器【客户端会将HTTP请求消息发送到重定向服务器上】
> 2. 重定向服务器收集来自各个路由器的路由信息，并根据这些信息找到最近的缓存服务器，然后将最近的缓存服务器的地址放到`Location字段`中返回响应【这样，客户端就会重新去访问指定的缓存服务器】
> 
> ***特点***：
>- 开销比较大【增加了HTTP消息的交互次数】
>- 精度较高【因为是根据客户端发送来的HTTP消息的发送方IP地址来估算距离的，而不是客户端的DNS服务器】
>- 如果重定向服务器离客户端很远，那就得不偿失了
## 服务器程序的结构
### 一对一
***一般一个客户端对应一个新的服务器程序***，因为服务器需要同时和多个客户端通信，但一个程序来处理多个客户端的请求是很难的[^32]

[^32]:服务器必须把握每一个客户端的操作状态






# 防火墙
>防火墙是一种抵御外部网络攻击的机制，它只允许发往指定服务器的指定应用程序的网络包通过
## 如何实现防火墙
防火墙如何才能从这些包中分辨出哪些可以通过，哪些不能通过呢？
>人们设计了多种方式 【防火墙可分为包过滤、应用层网关、电路层网关】，但出于性能、价格、易用性等因素，最为普及的是***包过滤方式***
## 包过滤的规则
>[!example] 假设我们的网络将开放给外网的Web服务器和公司内网分开部署，Web服务器所在的网络可以从外网直接访问。现在我们希望允许从互联网访问Web服务器 ①，但禁止Web服务器访问互联网 ②【为了避免一些寄生在Web服务器中感染其他服务器的恶意软件，如果阻止Web服务器访问互联网，就可以防止其他服务器被感染】
>
>- 包从互联网流向Web服务器，从互联网发送过来的包其起点是不确定的，但终点是确定的。因此，我们可以允许起点为任意，终点为Web服务器的包通过【表中第1行】
>- 从互联网发往 Web 服务器的包通过防火墙之后，Web服务器需要通过确认应答机制通知发送方数据已经正常收到，这需要Web服务器向互联网发送包。在Web服务器发往互联网的包中，我们可以将起点为Web服务器地址的包设置为允许通过【表中第3行】
>
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=0pE3Dhoi]]
### 通过端口号限定应用程序
按照前面的设置，相当于允许了互联网和Web服务器之间所有的包通过，这很危险。

因此，我们最好是阻止除必需服务以外的所有应用程序的包【可以在判断条件中加上TCP头部/UDP头部中的端口号。Web服务器的端口号为`80`，因此我们在刚才的接收方IP地址和发送方IP地址的基础上再加上`80`端口作为条件就可以了】
### 通过控制位判断连接方向
TCP在执行连接操作时需要收发3个包，第一个包的TCP控制位中`SYN`为1，`ACK`为0【其他的包中这些值都不同】
如果这第一个包是从 Web 服务器发往互联网的，那么我们就阻止它【表中第2行】。所以只要以Web服务器为起点访问互联网，其连接操作必然会失败。

>[!hint] 实际上也存在无法将希望允许和阻止的访问完全区分开的情况
>比如对于所有使用UDP协议的应用程序【DNS查询使用的是UDP协议，而UDP没有连接操作，因此无法根据控制位来判断访问方向。所以，我们无法只允许公司内部访问互联网上的DNS服务器，而阻止从互联网访问公司内部的服务器】

>[!faq] 如何设置公司内网和互联网之间，或者公司内网与公开区域之间的包过滤规则
>我们可以将接收方为公开区域的包设置成全部允许通过，并限定发送方只能为公司内网

>[!faq] 如何实现外部无法访问公司内网
>防火墙中具备***地址转换功能***【互联网和公司内网之间的包需要进行地址转换才能传输】
>
>由于使用地址转换，默认状态下是无法从互联网访问公司内网的【表中还没有对应的记录】，因此我们不需要再设置一条包过滤规则来阻止从互联网访问公司内网。

>[!hint] 包过滤只是路由器的包转发功能的附加功能
>包过滤并不是防火墙专用的一种特殊机制，只不过当判断规则比较复杂时，通过路由器的命令难以维护这些规则，而且对阻止的包进行记录对于路由器来说负担也比较大，因此才出现了专用的硬件和软件。
>
>如果规则不复杂，也不需要记录日志，那么可以用内置包过滤功能的普通路由器来充当防火墙
### 防火墙无法抵御的攻击
>防火墙***无法抵御未知的风险***【当服务器程序中有潜在的*Bug*未被发现时】

防火墙不关心包中的数据，所以如果有一个包可以导致Web服务器死机【由于Web服务器程序有*Bug*】，防火墙也无法发现，那么，当包到达Web服务器时，就会导致死机。

>[!hint] 解决办法
>- 修复Bug
>- 在防火墙之外部署用来检查包内容的设备或软件【但其实和第一种是一样的，因为我只有知道Bug是什么，我才能设置检查的规则】

>[!hint] 现在已经出现了很多可以绕过防火墙的攻击方法
>因此防火墙一般需要和反病毒、非法入侵检测、访问隔离等机制并用