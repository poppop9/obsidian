#计算机/四大件 
# 网络的全貌
浏览器和Web服务器之间的交互却很简单，概括如下：
(1)浏览器向Web服务器发送请求；
(2)Web服务器根据请求向浏览器发送响应；

要实现应用程序之间的交互，我们需要一个能够在浏览器和Web服务器之间传递请求和响应的机制。网络是由很多计算机等设备相互连接组成的，因此在通信的过程中需要确定正确的通信对象，并将请求和响应发送给它们。请求和响应在传递的过程中可能会丢失或损坏【请求和响应本质都是电信号和光信号，这些信号可能会因收到杂音等干扰而损坏】。所以需要一种机制，无论遇到任何情况都能够将请求和响应准确无误地发送给对方。
这种机制是由操作系统中的网络控制软件，以及交换机、路由器等设备分工合作来实现的，它的基本思路是将数字信息分割成一个一个的小块，然后装入一些被称为“包”(Packet)的容器中来运送。大家可以这样理解：包相当于信件或者包裹，而交换机和路由器则相当于邮局或快递公司的分拣处理区。包的头部存有目的地等控制信息，通过许多交换机和路由器的接力，就可以根据控制信息对这些包进行分拣，然后将它们一步一步地搬运到目的地。
无论是家庭和公司里的局域网，还是外面的互联网，它们只是在规模上有所不同，基本的机制都是相同的。

前面介绍的这个负责搬运数字信息的机制，再加上浏览器和Web服务器这些网络应用程序，这两部分就组成了网络。
# 基础概念知识
### URL
> 形如“http://”、“ftp://”、“file://”、“mailto://”等开头的链接，所以浏览器是一个具备多种客户端功能的综合性客户端软件，而URL的开头就是告诉浏览器使用其中哪种功能来访问相应的数据

`http://user:password@www.glasscom.com:80/dir/file1.htm`  --会包含服务器的域名，文件的路径
`ftp://user:password@ftp.glasscom.com:21/dir/file1.htm`
`file://localhost/c:/path/file1.zip`
`mailto:tone@glasscom.com`  --会包含收件人的邮件地址

***URL中还可能包含用户名，密码，端口号等信息***
##### URL省略文件名
- `http://www.lab.glasscom.com/dir/`---这种时候服务器就会访问`/dir/index.html`或`/dir/default.htm`
- `http://www.lab.glasscom.com/`---这表示服务器会访问***根目录***
- `http://www.lab.glasscom.com/`---这时会访问服务器根目录下的`index.html`或者`default.htm`文件
##### URL的层次结构
通过`.`来分割层级，***越靠右的层级越高***
```
例如 www.nikkeibp.co.jp
jp代表分配给日本这个国家的域，这个域的下一级又有很多域，co就是其中之一；
co代表公司的域，公司有很多公司，nikkeibp就是其中之一；
nikkeibp代表分配给这家公司的域
```
### TCP/IP
TCP/IP就是由一些小的子网【由集线器连接起来的几台计算机】，通过路由器连接起来组成一个大的网络
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=E5YjsPvZ|540]]
发送者发出的消息首先经过子网中的<u>集线器A</u>，转发到距离发送者最近的<u>路由器A</u>上，接着这个<u>路由器A</u>会根据目的地的位置判断要传送的下一个<u>路由器B</u>【传送到下一个子网的<u>集线器B</u>，再到<u>路由器B</u>】……直到到达目的地

***集线器***：按照以太网规则传输包的设备，集线器可以在子网中将网络包传输到下一个路由器
***路由器***：按照IP规则传输包的设备，路由器可以根据目标地址判断下一个路由器的位置
##### 地址
###### IP地址
>在同一网络下可以唯一标识的标识号，表示***网络号***+***主机号***。例如`10.11.12.13`

但由于网络号和主机号的具体结构是不固定的，所以我们要引入***子网掩码***来区分
###### 子网掩码
>子网掩码表示网络号与主机号之间的边界

子网掩码的表示方式：
- 十进制加分隔号`10.11.12.13/255.255.255.0`
- 网络号比特数`10.11.12.13/24`
###### MAC地址
- [ ] MAC地址的结构
>MAC地址长48bit。有两种写法：
>- `00-80-C8-2D-82-EA`
>- `00:80:C8:2D:82:EA`

- [ ] 如何知道目标的MAC地址？
> ***通过ARP协议查询目标路由器的MAC地址***：在以太网中，会通过广播把包发给连接在以太网中的所有设备。ARP会向所有设备提问“这个IP地址是谁的？请把你的MAC地址告诉我”，如果对方存在则会回应；如果路由表设置不正确，则只能认为对方不存在，包的发送就会失败。
##### TCP协议
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=ns2tkUMG|450]]
###### 如何建立管道和销毁管道
- 首先服务器先创建***套接字***【管道两端的数据出入口】【创建套接字后，协议栈会返回描述符（”号码牌“），因为浏览器可能要打开多个网页，所以也会有多个套接字，描述符用来标识套接字】，之后等待客户端连接管道；之后客户端也创建套接字，然后从该套接字延伸管道，连接到服务器端的套接字上。
- 当数据传送完毕之后，断开管道可以由任何一方发起，之后套接字随之销毁
>[!question] TCP是如何确定对方是否收到信息的？
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=4ZCrpyHv|800]]
###### TCP/IP包
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=NjKGz5z2|500]]
***IP头部***：包含自己网卡的IP地址，目的地的IP地址，协议号【包的内容类型】及其他信息
***MAC头部***：包含发送方和接收方的MAC地址，以太类型【IP协议，ARP协议，IPv6协议】

>[!question] 包是如何传输的？
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=N1r8Nq1n|600]]
>1. 网络包中有下一个路由器R1的MAC地址，有目的地服务器S的IP地址；
>2. 首先网络包会经过集线器，集线器通过包中的MAC头部信息，查找以太网表知道这个包该发往哪个路由器；
>3. 传输到<u>路由器R1</u>后根据IP表，知道要发往的下一个路由器的位置，但是为了发过去我们还需要查出下一个<u>路由器R2</u>的MAC地址，然后改写MAC头部；
>4. …………；
>5. 直到送达目的地；
##### UDP协议
UDP协议只负责发送包，出错时就收不到对方的回复，应用程序会注意到这个问题，会重新发送一遍数据
###### 什么情况下使用UDP协议？
- [ ] 数据很短，用一个包就能装得下的情况下【因为只有一个包，就不用考虑哪个包未送达了，就算重发也就是重发一个包】。***例如DNS查询***
- [ ] 重发数据也没什么意义时。***例如发送音频和视频数据时***【因为音频和视频必须在短时间内送达，不然会引起卡顿掉帧，而TCP协议繁琐的传输流程不合适，而且音频和视频缺少某些包一般可以接受】

==当需要穿越防火墙传输音频和视频数据时，我们有时会使用TCP协议【因为UDP经常会被防火墙阻止】==
##### 以太网
以太网是一种为多台计算机能够彼此自由和廉价地互相通信而设计的通信技术
###### 以太网的进化历史
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=qaHryAp7]]
>- [ ] (a)
>	***当一台计算机发送信号时，信号会通过网线流过整个网络，最终到达所有的设备***
>	收发器：将不同网线之间的信号连接起来
>
>- [ ] (b)
> 后来(a)变成了(b)，(b)的信号依旧会发送给所有设备，但是将主干网线-->中继式集线器【集线器】，将收发器网线-->双绞线
> 
>- [ ] (c)
>   交换式集线器被称为***交换机***
###### 以太网的特点
- [ ] 自动协商：确定最优的传输速率
>当两台设备通电并完成硬件初始化之后，就会开始用脉冲信号发送自己支持的速率【木桶效应】和工作模式【全/半双工】
##### 局域网LAN
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=bCkH68Rs]]

### DNS服务器
>域名服务系统，将IP地址与域名进行关联
##### DNS与域的关系
一台DNS服务器只能存储一个或者多个完整的域【比如`.com`域底下分了分多个层级，例如`.example`,`.google`等，那么一台DNS服务器只能完整的存储`.example`这个域，不能这台存一点`.example`，另一台又存一点`.example`】，当然全世界也可以只用一台DNS把`.com`这个域全部存了，但是太多了，只能分层
##### 缓存机制
每次查询IP地址都要从根域服务器开始那就效率太低了，所以DNS服务器里会有缓存，***可以记住之前查询过的域名***，下次查询可以快速响应。由于原本的域名注册信息会改变，这就会导致缓存里的注册信息是错误的，***所以缓存信息是有有效期的***
# Web浏览器
##### URL的解析
>生成HTTP请求之前需要对URL进行解析，确定Web服务器和文件名
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=nSIrYw3N|730]]
##### 生成HTTP请求信息
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=dzfRQA4Y|900]]
>***一条请求消息中只能写一条URI，如果要获取多个文件，必须对每个文件单独发送一条请求***
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=VVmY6Z7i|700]]

###### 方法
`GET`--获取URI指定的信息【如果URI是文件，则返回文件内容；如果URI是CGI程序，则返回输出结果】
`POST`--从客户端向服务端发送数据【一般用于发送<u>表单</u>[^1]中填写的数据】
`HEAD`--只从服务端返回消息头给客户端【用于获取文件最后更新时间等属性】
`OPTIONS`--用于通知或查询通信选项
`PUT`--替换URI指定的服务器上的文件，如果文件不存在，则创建该文件
`DELETE`--删除URI指定的服务器上的文件
`TRACE`--将服务器收到的请求行和头部直接返回给客户端【用于在使用代理的环境中检查改写请求】
`CONNECT`--使用代理传输加密消息

###### 消息头
- ***通用头***：适用于请求和响应消息的头字段
- ***请求头***：给请求消息添加附加消息
- ***响应头***：给响应消息添加附加消息
- ***实体头***：给消息体添加附加消息

[^1]:网页中的文本框，复选框等能够输入数据的部分
### 域名解析
>[!question] 为什么不直接在Web浏览器输入IP地址，还要域名干嘛？
>如果对方的服务器不使用虚拟主机的话，直接输入IP地址也是可以访问网页的。***但是对比于一串数字，域名更加好记啊***

>[!question] 那为什么不直接用域名来确定通信对象呢?
>IPv4地址只有32bit，域名是字符串占用内存太多，***增加服务器负担，效率低下***

##### 通过解析器向DNS服务器发送查询信息
解析器【解析器实际上是一段程序，它包含在操作系统的`Socket库`【网络开发的标准库】中】会生成查询消息，之后委托给操作系统内部的协议栈发送查询消息给DNS服务器，最后通过网卡发送出去
```mermaid
graph LR
	a[应用程序]--调用-->b[解析器]--委托-->c[协议栈]--委托-->d[网卡]--发送消息-->e[DNS服务器]
	
	e--返回响应消息-->d--返回消息-->c--返回消息-->b--返回消息-->a
```
##### 接收DNS服务器返回的响应消息，并解析
解析得到IP地址后，将其写入到Web浏览器的内存地址中，后续浏览器向Web服务器发送消息时，只要从该内存地址取出IP地址，并将其和HTTP请求消息一起交给操作系统即可
### 全世界DNS服务器的大接力
全世界的每台DNS服务器都具有根域服务器的IP地址，所以客户端只要能找到一台DNS服务器就可以找到根域服务器【但是查询的过程中，最近的DNS服务器会一直询问，直到找到IP地址】
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=ROH2XNi4|600]]
有了这些条件，接下来就是应用程序委托***协议栈***发送消息了
# 协议栈
***协议栈***：网络控制软件
***网卡***：网络硬件

>协议栈的内部结构：
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=mSlDrTNw]]
>***ICMP协议***：用于告知网络包传送过程中产生的错误以及各种控制信息
>***ARP协议***：用于根据IP地址查询相应的***以太网MAC地址***
### 使用TCP协议传输
##### 创建套接字
- 准备创建套接字【套接字就是存放控制信息（IP地址，端口号，通信状态）的内存空间的抽象概念】
- 协议栈向操作系统申请内存空间来放置套接字，并将套接字设为初始状态
- 套接字创建成功之后，协议栈会返回一个描述符给应用程序，用于唯一标识套接字
##### 连接Web服务器
- 服务器程序一般会在系统启动时就创建套接字，***等待服务端进行连接***
- 之后TCP模块会把包含控制信息的***以太网头部***，***TCP头部***的网络包委托给***IP模块***进行发送
- 等到服务器端的***IP模块***接收到信息后，就把信息传递给服务器端的***TCP模块***，服务器根据这些信息就知道自己要使用哪个套接字，也知道了客户端的信息。
- 服务端会修改套接字的状态
- 服务端向客户端发送信息，告诉客户端已收到，可以进行连接
- 客户端收到信息后，会再次给服务端发信息说，我收到了
- 至此，连接完成
>[!question] 为什么最后还要多此一举向服务器端发送消息？
>最后一次是客户端向服务器端发送网络包的随机序列号，我们不能真的从1开始傻傻的排序，因为这样通信过程很容易被预测，容易被攻击，***所以起始序列号必须随机***
##### 收发数据
指定***描述符***和***需要发送的数据***，协议栈通过***套接字***【连接成功后，套接字中会有通信对方的信息，所以发送数据无需指明***IP地址***和***端口号***】把数据发送给Web服务器
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=No6ib08t|600]]
>发送时，发送方会说“现在发送的是从xx字节开始的部分，一共有xx字节”
>接收方则回复说“到xx字节之前的数据我已经收到了”
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=H9yqiQ8G|530]]
##### 断开连接
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=UZ67GJjD|520]]
##### 删除套接字
为了***防止误操作***，删除套接字要过一段时间
```
在断开连接时，服务器最后发送给客户端的ACK号丢失了，那么客户端会再次发送一个 FIN:1的包。
如果这时服务器端的套接字已经删除了，更巧的是，某个在服务器端的另一个程序重新创建的套接字的端口号与刚刚被删除的套接字的端口号一样，那。。。接下来的通信就是“牛头不对马嘴”
```

经过协议栈之后，我们就已经得到了带有各种控制信息的包，接下来我们把包交给网卡进行传输
# 网卡
***网卡***：可能是<u>计算机主板上的板卡</u>，<u>笔记本上的PCMCIA卡</u>，或者是<u>计算机主板上集成的芯片</u>
```mermaid
graph LR
	a(协议栈)--带有0和1的数字信号的网络包-->b(网卡)--电信号/光信号-->c(网线/光纤)
	c-->d(路由器,集线器等转发设备)
	d-->e(接收方)
```
>网卡的内部结构
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=KlPCtkvx|600]]
### 网卡将包转换成电信号通过网线发送出去
网卡驱动从IP模块获取包之后，会将其复制到网卡内的缓冲区中；
接下来MAC模块会将包从缓冲区中取出，并在开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列；
***之后网卡的MAC模块生成电信号【通用信号】，然后由PHY(MAU)模块转换成可在网线中传输的格式，并通过网线发送出去***
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=ZpB4IHEP|500]]

# 网线
### 传输电信号
>[!question] 怎么解决传输时电信号的衰减？
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=8iOnlDvg|500]]
>***使用双绞线【将两根信号线缠绕在一起形成一组】***
>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=pZqxXexl|600]]

# 集线器，交换机，路由器
我们的家用路由器已经集成了<u>集线器</u>，<u>交换机</u>的功能

现在我们基本不使用集线器了，而是直接将计算机连接到交换机上

>[!question] 网卡与交换机的区别
>- ***网卡本身具有MAC地址***，***而交换机的端口不具有MAC地址***
>- ***网卡会根据MAC地址核对包是不是发给自己的***，***而交换机则接收所有的包并存放到缓冲区***

>[!question] 集线器与交换机的区别
>- ***交换机具有更好的性能和碰撞管理能力***
>- ***交换机会根据MAC地址将包发送到正确的端口，而不是广播。从而减少了碰撞的可能性***
>- 交换机的端口速度和带宽远高于集线器

>[!question] 交换机与路由器的区别
>***交换机是基于 以太网 设计的***
>***路由器是基于 IP 设计的***

交换机 = 计算机 + 多块网卡 + 开启“混杂模式”【让网卡接收所有的包】+ 安装网络包转发软件

>[!question] 交换机中的MAC表是如何维护的？
>- 当<u>发送方</u>向交换机发送包时，交换机会记录发送方的MAC地址和包进入交换机时的端口号。【***以便以后要向该发送方发送包时，交换机可以快速反应***】
>- MAC表会在一段时间删除一些记录【防止终端设备移动产生问题】
### 集线器收到来自网线的信号
当信号到达集线器后，会被广播到连接集线器的所有设备，这些设备收到信号之后会通过MAC地址判断是不是发给自己的【是则接收，否则忽略】
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=fWnWn5MN|570]]
### 交换机收到来自集线器的信号
信号到达交换机之后的处理与网卡基本相同【==可以认为交换机的每个网线接口和后面的电路部分都是一块网卡==】：
- 信号到达网线接口，由PHY(MAU)模块进行接收，并将信号转换为通用格式传递给MAC模块
- MAC模块将信号转换为数字信息，之后校验FCS【没问题则放入缓冲区，否则丢弃】
- 包放入缓冲区后，则根据MAC表查询接收方的MAC地址应该通过哪个端口发送出去【有记录则发送，无记录则广播】
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=Po3EOEWg|570]]
### 路由器收到来自交换机的信号
- 首先，根据对应的通信技术【以太网/无线局域网】将从端口发送过来的包接收进来
- 接下来，转发模块会根据包的 IP头部 在路由表中查询
>查询时只匹配网络号，忽略主机号，根据<u>子网掩码</u>来决定发送的优先级，无选项时选择<u>默认网关</u>：
>>例如，要发送一个包到`192.168.1.10`服务器：
>>- 首先根据子网掩码判断符合对象，第三行的子网掩码表示只判断前 24 个bit位，所以第三行符合要求；第四行也符合要求；第五行的子网掩码表示需要符合的bit位是0，所以也符合。
>>- 接着是确定优先级：子网掩码位数越多，优先级越高，因为范围越小。第四行的目标地址根据子网掩码可以判断是一个服务器的地址；第三行是一个子网地址；
>>- 把包发送给第四行的地址，如果符合则结束，否则发送给下一优先级的地址
>>- 如果前面的地址都不匹配，则发送给***默认网关***【第五行】
>>![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=fP0Bxd5i|500]]
- 更新<u>IP头部</u>的TTL有效期

> 路由器的内部结构：
> ![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=c8bABV8y|600]]
> ***转发模块***：负责判断包的转发目的地，类似于==IP模块==
> ***端口模块***：负责包的收发操作，类似于==网卡==





# 接入网，网络运营商

# 防火墙，缓存服务器

# Web服务器
##### 收到响应
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=Abd79e9Y|600]]
###### 状态码
![[Excalidraw/计算机/四大件/计算机网络 Draw.md#^group=XPJza8ki|600]]
##### 一些操作
##### 接收数据
- 协议栈会检查收到的数据块和TCP头部内容，如果没问题则返回ACK号
- 将数据暂存到接收缓冲区，并按顺序还原出原始数据
- 协议栈尝试从缓冲区中取出数据并传递给应用程序
