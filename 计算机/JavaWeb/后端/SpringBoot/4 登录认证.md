# ğŸŒ•ç™»å½•æ ¡éªŒ
>åœ¨ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œæ— æ³•è®¿é—®è¯¥ç½‘ç«™çš„å…¶ä»–å­é¡µé¢

>[!quote] ä¼šè¯
>ä¸€æ¬¡ä¼šè¯ä»æ‰“å¼€æµè§ˆå™¨è®¿é—®WebæœåŠ¡å™¨å¼€å§‹ï¼Œç›´åˆ°å…¶ä¸­ä¸€æ–¹æ–­å¼€è¿æ¥ï¼Œä¸€æ¬¡ä¼šè¯ç»“æŸã€‚***ä¸€æ¬¡ä¼šè¯å¯ä»¥åŒ…å«å¤šæ¬¡è¯·æ±‚å’Œå“åº”***

>[!quote] ä¼šè¯è·Ÿè¸ª
>æœåŠ¡å™¨æ¥è¯†åˆ«å¤šæ¬¡è¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€ä¸ªæµè§ˆå™¨ï¼Œä»¥ä¾¿åœ¨å¤šæ¬¡è¯·æ±‚ä¸­å…±äº«æ•°æ®

>[!hint] ç›®å‰ä¸»æµä½¿ç”¨ JWTä»¤ç‰Œ
##### ğŸŒ‘Cookie å®¢æˆ·ç«¯ä¼šè¯è·Ÿè¸ªæŠ€æœ¯
>æœåŠ¡ç«¯ä¼šåˆ›å»ºä¸€ä¸ªCookieå“åº”ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä¼šæŠŠè¿™ä¸ªCookieä¿å­˜ä¸‹æ¥ï¼Œä¹‹åå†å‘èµ·è¯·æ±‚æ—¶æµè§ˆå™¨ä¼šæºå¸¦Cookieï¼ŒæœåŠ¡ç«¯æ ¹æ®Cookieåˆ¤æ–­ä¼šè¯å¯¹è±¡

- ä¼˜ç‚¹
	- HTTPåè®®ä¸­æ”¯æŒçš„æŠ€æœ¯
- ç¼ºç‚¹
	- ç§»åŠ¨ç«¯æ— æ³•ä½¿ç”¨
	- ä¸å®‰å…¨
	- ç”¨æˆ·å¯ä»¥è‡ªè¡Œç¦ç”¨Cookie
	- Cookiesä¸èƒ½è·¨åŸŸã€***æ„å‘³ç€å‰åç«¯åˆ†ç¦»çš„è®¾è®¡æ¨¡å¼æ— æ³•ä½¿ç”¨***ã€‘
##### ğŸŒ‘Session æœåŠ¡ç«¯ä¼šè¯è·Ÿè¸ªæŠ€æœ¯
>åŸºäºCookieæŠ€æœ¯å®ç°

- ä¼˜ç‚¹
	- å®‰å…¨ã€æ•°æ®å­˜å‚¨åœ¨æœåŠ¡ç«¯ã€‘
- ç¼ºç‚¹
	- æœåŠ¡å™¨é›†ç¾¤éƒ¨ç½²ä¸‹æ— æ³•ä½¿ç”¨SessionæŠ€æœ¯
	- Cookieçš„æ‰€æœ‰ç¼ºç‚¹

>[!hint] Cookie ä¸ Session å·²ç»å¾ˆå°‘ä½¿ç”¨äº†ï¼Œç°åœ¨ä¸»æµä½¿ç”¨ JWTä»¤ç‰Œ
##### ğŸŒ‘JWTä»¤ç‰Œ
>JWTä»¤ç‰Œã€Json Web Tokenã€‘å°±æ˜¯ç”¨æˆ·æ ‡è¯†ï¼Œå¯¹Jsonæ ¼å¼è¿›è¡Œäº† `Base 64ç¼–ç ` + ç­¾åç®—æ³•

- ä¼˜ç‚¹
	- æ”¯æŒå¤šç«¯ã€ä»¤ç‰Œå¯ä»¥å­˜å‚¨åœ¨é™¤Cookieä»¥å¤–çš„å…¶ä»–å­˜å‚¨ç©ºé—´ä¸­ã€‘
	- æ”¯æŒæœåŠ¡ç«¯é›†ç¾¤éƒ¨ç½²
	- å‡è½»äº†æœåŠ¡ç«¯å­˜å‚¨å‹åŠ›ã€æ— éœ€åœ¨æœåŠ¡ç«¯å­˜å‚¨æ•°æ®ã€‘
- ç¼ºç‚¹
	- éœ€è¦è‡ªå·±å®ç°
	- éœ€è¦å’Œå‰ç«¯é…åˆ
###### ğŸŒ™ç»„æˆ
![[Excalidraw/è®¡ç®—æœº/JavaWeb Draw.md#^group=MNBxap8H|870]]
###### ğŸŒ™å®ç°æµç¨‹
- åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œåœ¨æœåŠ¡ç«¯ç”ŸæˆJWTä»¤ç‰Œ
- å°†ä»¤ç‰Œä¸‹å‘ç»™å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯æŠŠä»¤ç‰Œå­˜å‚¨èµ·æ¥
- å®¢æˆ·ç«¯åœ¨ä¹‹åçš„æ¯ä¸€æ¬¡è¯·æ±‚æ—¶æºå¸¦è¯¥ä»¤ç‰Œ
- æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ä¹‹åè¿›è¡Œç»Ÿä¸€æ‹¦æˆªï¼Œè·å–åˆ°è¯·æ±‚ä¸­æºå¸¦çš„ä»¤ç‰Œï¼Œå¹¶æ ¡éªŒä»¤ç‰Œçš„çœŸä¼ª
	- æ— æ•ˆï¼Œå“åº”é”™è¯¯ç»“æœ
	- æœ‰æ•ˆï¼Œå…è®¸è®¿é—®å¯¹åº”çš„ä¸šåŠ¡æ¥å£
###### ğŸŒ™å‡†å¤‡å·¥ä½œ
- å¼•å…¥ä¾èµ–
```xml
<dependency>  
    <groupId>io.jsonwebtoken</groupId>  
    <artifactId>jjwt</artifactId>  
    <version>0.9.1</version>  
</dependency>
```
###### ğŸŒ™å…·ä½“å®ç°
![[Excalidraw/è®¡ç®—æœº/JavaWeb Draw.md#^group=t8jOJfVI|790]]
```java
package com.example.utils;

public class CreateJWT {
    public String CreateJWT(Map<String, Object> claims) {
        //é“¾å¼ç¼–ç¨‹
        String jwt = Jwts.builder()
                .signWith(SignatureAlgorithm.HS256, "greenteck")  //è®¾ç½®ç­¾åç®—æ³•ï¼Œå¯†é’¥
                .setClaims(claims)  //è®¾ç½®è‡ªå®šä¹‰å†…å®¹ã€è¿™é‡Œç”¨mapé›†åˆè¡¨ç¤ºjsonã€‘
                .setExpiration(new Date(System.currentTimeMillis() + 3600 * 1000))  //è®¾ç½®ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ
                .compact();  //æœ€åè¿”å›ä»¤ç‰Œ

        return jwt;
    }

    public void AnalysisJWT() {
        Claims claims = Jwts.parser()   //è°ƒç”¨è§£æå™¨
                .setSigningKey("greenteck")   //ä¼ å…¥å¯†é’¥
                .parseClaimsJws("eyJhbGciOiJIUzI1NiJ9.eyJraW4iOiJib29nYWxvbyIsImpheWdlZSI6InNjYXJlY3JvdyIsImV4cCI6MTcwMTM5Njc4NH0.Oiv7vVbwJkwEO0sa-4V0sRqgHkWP1sJpXlXppFblRO8")  //å£°æ˜ä»¤ç‰Œ
                .getBody();  //è·å–ç¬¬äºŒéƒ¨åˆ†

        System.out.println(claims);
    }
}
```

```java
package com.example.controller;

@RestController
public class ManagerLoginController {
    @Autowired
    private ManagerLoginService mls;

    @PostMapping("/login")
    public Result login(@RequestBody manager manager) {
        manager m = mls.ManagerLogin(manager);
        System.out.println(m);

        if (m != null) {  //ä¸‹å‘ä»¤ç‰Œ
            Map<String, Object> claims = new HashMap<>();
            claims.put("id",m.getId());
            claims.put("account",m.getAccount());
            claims.put("password",m.getPassword());

            CreateJWT createJWT = new CreateJWT();
            String jwt = createJWT.CreateJWT(claims);
            return Result.buildResult(Result.Status.OK, jwt);
        } else {
            return Result.buildResult(Result.Status.PWD_ERROR);
        }
    }
}

---
manager(id=1, account=123, password=abc)
```

```java
package com.example.service;

@Service
public interface ManagerLoginService {
    //æ ¹æ®è´¦å·ï¼Œå¯†ç æŸ¥è¯¢ç”¨æˆ·
    manager ManagerLogin(manager manager);
}
```

```java
package com.example.service.impl;

@Service
public class ManagerLoginService implements com.example.service.ManagerLoginService {
    @Autowired
    private ManagerLoginMapper mlm;

    @Override
    public manager ManagerLogin(manager manager) {
        return mlm.SelectManager(manager);
    }
}
```

```java
package com.example.mapper;

@Mapper
public interface ManagerLoginMapper {
    @Select("SELECT * FROM manager WHERE account=#{account} AND password =#{password}")
    manager SelectManager(manager manager);
}
```

>[!hint] å½“ ***ç¯¡æ”¹ä»¤ç‰Œ*** æˆ– ***ä»¤ç‰Œè¿‡æœŸ*** è§£æä»¤ç‰Œæ—¶å°±ä¼šæŠ¥é”™

### ğŸŒ—ç»Ÿä¸€æ‹¦æˆª
>[!hint] ç›®å‰ä¸»æµä½¿ç”¨Interceptor
##### ğŸŒ‘è¿‡æ»¤å™¨Filter
>Filteræ˜¯ JavaWeb çš„ä¸‰å¤§ç»„ä»¶ã€Servletï¼ŒFilterï¼ŒListenerã€‘ä¹‹ä¸€ï¼Œå¯ä»¥æŠŠå¯¹èµ„æºçš„è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œä»è€Œ***å®Œæˆä¸€äº›é€šç”¨çš„æ“ä½œ***ã€ç™»å½•æ ¡éªŒï¼Œç»Ÿä¸€ç¼–ç å¤„ç†ï¼Œæ•æ„Ÿå­—ç¬¦å¤„ç†â€¦â€¦ã€‘
###### ğŸŒ™æ‰§è¡Œæµç¨‹
![[Excalidraw/è®¡ç®—æœº/JavaWeb Draw.md#^group=D_tAwfzgeAtpLUlBUPLDq|790]]
![[Excalidraw/è®¡ç®—æœº/JavaWeb Draw.md#^group=jcttnSam7dZdpCHQLsr6b|640]]
##### ğŸŒ‘æ‹¦æˆªå™¨Interceptor
>Springæ¡†æ¶ä¸­æä¾›çš„ç”¨æ¥åŠ¨æ€æ‹¦æˆªControlleræ–¹æ³•çš„æ‰§è¡Œ

![[Excalidraw/è®¡ç®—æœº/JavaWeb Draw.md#^group=OSBwvT3c5koJtOdxWudzQ|700]]

```xml
<!--é˜¿é‡Œå·´å·´çš„fastJson--> 
<dependency>  
    <groupId>com.alibaba</groupId>  
    <artifactId>fastjson</artifactId>  
    <version>1.2.75</version>  
</dependency>
```

```java
//æ‹¦æˆªå™¨ç±»
package com.example.interceptor;

import org.springframework.util.StringUtils;

@Component  //äº¤ç»™IOCå®¹å™¨
public class LoginCheckInterceptor implements HandlerInterceptor {  //å®ç°HandlerInterceptoræ¥å£
    //åœ¨Controlleræ–¹æ³•ä¹‹å‰è¿è¡Œã€è¿”å›trueåˆ™æ”¾è¡Œï¼Œfalseåˆ™ä¸æ”¾è¡Œã€‘
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //è·å–è¯·æ±‚çš„url
        String url = request.getRequestURL().toString();

        //è·å–è¯·æ±‚å¤´ä¸­çš„ä»¤ç‰Œ
        String jwt = request.getHeader("token");

        //ä»¤ç‰Œä¸å­˜åœ¨
        if (StringUtils.hasLength(jwt) == false) {
            //æ‰‹åŠ¨åˆ©ç”¨requestå¯¹è±¡å“åº”é”™è¯¯ä¿¡æ¯ã€å› ä¸ºä¸æ˜¯Controllerï¼Œä¸èƒ½è‡ªåŠ¨å°†Resultå“åº”å¯¹è±¡è½¬æ¢ä¸ºjsonã€‘
            String NoLogin = JSONObject.toJSONString(Result.buildResult(Result.Status.UNAUTHORIZED));
            response.getWriter().write(NoLogin);
            //ä¸æ”¾è¡Œ
            return false;
        }

        //åªè¦è§£æä»¤ç‰ŒæŠ¥é”™å°±è¯´æ˜ä»¤ç‰Œå‡ºé”™äº†
        JWTUtils jwtUtils = new JWTUtils();
        try {
            jwtUtils.AnalysisJWT(jwt);
        } catch (Exception e) {
	        //å°†Resultå¯¹è±¡è½¬æ¢ä¸ºJsonæ ¼å¼
            String NoLogin = JSONObject.toJSONString(Result.buildResult(Result.Status.UNAUTHORIZED));
            response.getWriter().write(NoLogin);
            return false;
        }

        //æ”¾è¡Œ
        return true;
    }

    //åœ¨Controllerç±»è¿è¡Œå®Œä¹‹åè¿è¡Œ
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
		â€¦â€¦
    }

	//è§†å›¾æ¸²æŸ“å®Œæ¯•åè¿è¡Œ
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
		â€¦â€¦
    }
}
```

```java
//æ‹¦æˆªå™¨çš„é…ç½®ç±»
package com.example.config;

@Configuration  //è¡¨ç¤ºæ˜¯ä¸€ä¸ªé…ç½®ç±»
public class WebConfig implements WebMvcConfigurer {  //å®ç°WebMvcConfigureræ¥å£
    @Autowired
    private LoginCheckInterceptor loginCheckInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginCheckInterceptor)  //æ·»åŠ è¦é…ç½®çš„Interceptorç±»
                .addPathPatterns("/**")  //æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
                .excludePathPatterns("/login");  //ä¸æ‹¦æˆªå¯¹/loginçš„
    }
}
```

```java
//ä»¤ç‰Œçš„å·¥å…·ç±»
package com.example.utils;

public class JWTUtils {
    public String CreateJWT(Map<String, Object> claims) {
        //é“¾å¼ç¼–ç¨‹
        String jwt = Jwts.builder()
                .signWith(SignatureAlgorithm.HS256, "greenteck")  //è®¾ç½®ç­¾åç®—æ³•ï¼Œå¯†é’¥
                .setClaims(claims)  //è®¾ç½®è‡ªå®šä¹‰å†…å®¹ã€è¿™é‡Œç”¨mapé›†åˆè¡¨ç¤ºjsonã€‘
                .setExpiration(new Date(System.currentTimeMillis() + 3600 * 1000))  //è®¾ç½®ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ
                .compact();  //æœ€åè¿”å›ä»¤ç‰Œ

        return jwt;
    }

    public void AnalysisJWT(String jwt) {
        Claims claims = Jwts.parser()   //è°ƒç”¨è§£æå™¨
                .setSigningKey("greenteck")   //ä¼ å…¥å¯†é’¥
                .parseClaimsJws(jwt)  //å£°æ˜ä»¤ç‰Œ
                .getBody();  //è·å–ç¬¬äºŒéƒ¨åˆ†
    }
}
```

>[!hint] Interceptorä¸­çš„è·¯å¾„å‚æ•°
>`/*`  è¡¨ç¤ºæ‰€æœ‰çš„ä¸€çº§è·¯å¾„ï¼Œ***ä¸åŒ…æ‹¬*** `/user/1`
>`/**`  è¡¨ç¤ºæ‰€æœ‰çš„è·¯å¾„
>`/user/*`  è¡¨ç¤º `/user` ä¸‹çš„æ‰€æœ‰ä¸€çº§è·¯å¾„ï¼Œä¸åŒ…æ‹¬ `/user/s/1`
>`/user/**` è¡¨ç¤º `/user` ä¸‹çš„æ‰€æœ‰è·¯å¾„
# ğŸŒ•å¼‚å¸¸å¤„ç†


