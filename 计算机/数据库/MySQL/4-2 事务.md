
>[!quote] 事务
>>事务 是一组 SQL 语句
>
> - **原子性**：事务要么完全执行，要么完全不执行
> - **一致性**：事务完成时，必须使<u>所有数据都保持一致状态</u>【~~比如部门表中的某个部门被删除了，那员工表中就不会出现该部门下的员工~~】
> - **隔离性**：只要不 COMMIT，则别的窗口看不到数据的变化
> - **持久性**：事务一旦 COMMIT / ROLLBACK，则数据永久改变

>[!hint] 事务处理可以回退 `INSERT`, `UPDATE`, `DALETE`。不能回退 `SELECT`, `CREATE`, `DROP`

# 手动事务
- `@@autocommit = 1` 事务的提交方式是自动提交【默认】
- `@@autocommit = 0` 事务需要手动提交

```sql
SELECT @@autocommit;

---
1
```

```sql
SET @@autocommit = 0;

INSERT INTO test_work
VALUES (3, 'greenteck', '888');
-- 此时数据未更新

COMMIT;
-- 此时数据更新

-- 如果出错了可以使用 `ROLLBACK;` 回滚事务
```


---

**如果执行过程中没有发生错误，则 COMMIT 整组 SQL 语句；如果发生错误，则 ROLLBACK，将数据库恢复到正常状态**

- `START TRANSACTION;`  开始事务
- `COMMIT;`  结束事务并提交
- `ROLLBACK;`  回退到事务处理之前
- `SAVEPOINT 保留点名;`  设置保留点：允许在事务中的特定位置进行部分回滚，而不必回滚整个事务

```sql
START TRANSACTION;    //第一步先执行此语句

SAVEPOINT point1;    //设置一个保留点

UPDATE table SET id = 188;       //-------------------
UPDATE table SET name = Tom;      //然后执行这组语句体
UPDATE table SET age = 18;       //-------------------

---

COMMIT;      //如果这组语句体都执行成功，则可以执行COMMIT来提交

ROLLBACK;     //如果有语句执行失败了，则执行ROLLBACK来回退

ROLLBACK TO point1;  //返回到保留点point1
```
