# â¤ é™æ€ä»»åŠ¡
>[!quote] é™æ€ä»»åŠ¡
> é™æ€ä»»åŠ¡ æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±è¢«åŠ è½½å’Œæ³¨å†Œçš„å®šæ—¶ä»»åŠ¡ï¼Œè°ƒåº¦æ—¶é—´åœ¨åº”ç”¨å¯åŠ¨æ—¶å°±è¢«è®¡ç®—ã€‚å®ƒä»¬æ˜¯åŸºäºé…ç½®æ–‡ä»¶æˆ–ä»£ç ä¸­çš„ `@Scheduled` æ³¨è§£å£°æ˜çš„

```java
@Scheduled(cron="0 0 2 * * ?") //æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void doStaticTask() {
    // æ‰§è¡Œé™æ€å®šæ—¶ä»»åŠ¡çš„ä»£ç 
}
```

## ğŸ’› æ“ä½œæ­¥éª¤
- åœ¨ç±»ä¸ŠåŠ å…¥ `@EnableScheduling`ï¼Œ<u>å¼€å¯å®šæ—¶ä»»åŠ¡</u>
```java
@EnableScheduling
public class ChatBotSchedule {â€¦â€¦}
```

- ä½¿ç”¨ `@Scheduled`ï¼Œå¯¹ä»»åŠ¡<u>è®¾ç½®æ‰§è¡Œæ—¶é—´</u>ã€‚æœ‰ä¸‰ç§é…ç½®æ‰§è¡Œæ—¶é—´çš„æ–¹å¼ï¼š
	- `cron è¡¨è¾¾å¼` 
	- `fixedRate` è‡ªä¸Šä¸€æ¬¡æ‰§è¡Œå¼€å§‹ä¹‹åå¤šé•¿æ—¶é—´æ‰§è¡Œã€~~å•ä½æ˜¯æ¯«ç§’~~ã€‘
	- `fixedRateString` ä¸ `fixedRate` ç›¸åŒï¼Œä½†æ˜¯<u>æ”¯æŒå ä½ç¬¦</u>
	- `fixedDelay` è‡ªä¸Šä¸€æ¬¡æ‰§è¡Œç»“æŸä¹‹åå¤šé•¿æ—¶é—´æ‰§è¡Œã€~~å•ä½æ˜¯æ¯«ç§’~~ã€‘
	- `fixedDelayString`
	- `initialDelay` é¦–æ¬¡æ‰§è¡Œè¦å»¶è¿Ÿå¤šé•¿æ—¶é—´ã€~~å•ä½æ¯«ç§’~~ã€‘
	- `initialDelayString`

```java
@Scheduled(cron = "0/20 * * * * ?")  

@Scheduled(fixedRate = 1 * 60 * 1000)  

// é…ç½®æ–‡ä»¶ä¸­
interval=2000
@Scheduled(fixedRateStirng="${interval}")
public void RunSchedule() {â€¦â€¦}
```

## ğŸ’› @Scheduled
### ğŸ’™ Cron è¡¨è¾¾å¼
`cron= "ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨å‡ "`

>[!warning] `å‘¨` å’Œ `æ—¥` ä¸èƒ½åŒæ—¶å­˜åœ¨ã€ä¸€ä¸ªè®¾ç½®äº†ï¼Œå¦ä¸€ä¸ªå°±è¦è®¾ç½®ä¸º `?` ã€‘

- å–å€¼
	- `ç§’` 0-59
	- `åˆ†` 0-59
	- `æ—¶` 0-23
	- `æ—¥` 1-31
	- `æœˆ` 1-12
	- `å‘¨` 1-7ã€1 è¡¨ç¤º å‘¨æ—¥ï¼Œ7 è¡¨ç¤ºå‘¨å…­ã€‘
- é€šé…ç¬¦
	- `#` æ¯æœˆçš„ç¬¬å‡ ä¸ªå‘¨å‡ ã€æ¯”å¦‚ `1#2`ï¼Œè¡¨ç¤ºæ¯æœˆçš„ç¬¬ 2 ä¸ªæ˜ŸæœŸå¤©ã€‘ã€==åªç”¨åœ¨å‘¨==ã€‘
	- `L` æ¯æœˆçš„æœ€åä¸€ä¸ªä»€ä¹ˆã€æ¯”å¦‚ï¼Œåœ¨æ—¥ä¸Š `3L` è¡¨ç¤ºè¿™ä¸ªæœˆçš„å€’æ•°ç¬¬ä¸‰å¤©ï¼Œå‘¨ä¸Š `3L` è¡¨ç¤ºè¿™ä¸ªæœˆçš„æœ€åä¸€ä¸ªå‘¨å››ã€==åªç”¨åœ¨å‘¨ï¼Œæˆ–æ—¥==ã€‘ã€Spring ä¸­ä¸æ”¯æŒã€‘
	- `*` æ‰€æœ‰å€¼ï¼Œè¡¨ç¤ºæ¯ç§’ï¼Œæ¯æœˆï¼Œæ¯æ—¥
	- `?` ä¸æŒ‡å®šå€¼ã€æ¯”å¦‚å·²ç»è®¾ç½®äº†æ¯æ—¥ï¼Œé‚£å…·ä½“å‘¨å‡ å°±ä¸ç”¨è®¾ç½®äº†ï¼Œé‚£ä¹ˆå°±è®¾ä¸º `?` ã€‘
	- `-` è¡¨ç¤ºåŒºé—´ã€æ¯”å¦‚åœ¨å‘¨ä¸Šè®¾ç½® `3-5`ï¼Œå°±è¡¨ç¤ºå‘¨ä¸‰åˆ°å‘¨äº”éƒ½ä¼šæ‰§è¡Œã€‘
	- `,` å¤šä¸ªå¹¶åˆ—ã€æ¯”å¦‚æ—¥çš„ `2,13,14`ï¼Œå°±æ˜¯2å·ï¼Œ13å·ï¼Œ14å·éƒ½ä¼šæ‰§è¡Œã€‘
	- `/` é—´éš”ã€æ¯”å¦‚ç§’çš„ `2/3`ï¼Œä»ç¬¬ 2 ç§’å¼€å§‹ï¼Œæ¯ä¸‰ç§’è§¦å‘ä¸€æ¬¡ã€‘

```java
0/2 * * * * ?   ä»ç¬¬ 0 ç§’å¼€å§‹ï¼Œæ¯ 2 ç§’è§¦å‘

0 0/5 14 * * ?    åœ¨æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:55 æœŸé—´çš„æ¯5åˆ†é’Ÿè§¦å‘ã€2 ç‚¹ä¼šè§¦å‘ï¼Œ2:55 ä¹Ÿä¼šè§¦å‘ã€‘

0 15 10 ? * 6#3   æ¯æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ 10:15 è§¦å‘

0 0 2 1 * ?   æ¯æœˆçš„ 1 å·ï¼Œå‡Œæ™¨ 2 ç‚¹è§¦å‘

0 * 14 * * ?    æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:59 çš„æ¯ 1 åˆ†é’Ÿè§¦å‘

0 0-5 14 * * ?    æ¯å¤©ä¸‹åˆ 2 ç‚¹åˆ°ä¸‹åˆ 2:05 çš„æ¯ 1 åˆ†é’Ÿè§¦å‘ 
```

### ğŸ’™ fixedRate
fixedRate çš„æ—¶é—´å•ä½æ˜¯æ¯«ç§’

```java
@Scheduled(fixedRate = 6300000) // 1h 45min
```

### ğŸ’™ fixedRateString
```java
// é…ç½®æ–‡ä»¶
interval=2000

// æ³¨è§£å¼•ç”¨
@Scheduled(fixedRateStirng="${interval}")
```

### ğŸ’™ initialDelay
```java
// ç³»ç»Ÿå¯åŠ¨ä¹‹åç«‹é©¬ä¼šæ‰§è¡Œä¸€æ¬¡
@Scheduled(fixedRate = 6300000, initialDelay = 0)
```



## ğŸ’› å¼‚æ­¥å¤šçº¿ç¨‹å®šæ—¶ä»»åŠ¡
å¦‚æœåº”ç”¨ç¨‹åºä¸­æœ‰å¤šä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè¿™æ—¶æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å°šæœªå®Œæˆï¼Œé‚£ä¹ˆå…¶ä»–å®šæ—¶ä»»åŠ¡ä¹Ÿä¼šæ’é˜Ÿç­‰å¾…

- æ·»åŠ  `EnableAsync` ï¼Œå¼€å¯å¼‚æ­¥
```java
@EnableAsync
@EnableScheduling
public class ChatBotSchedule {â€¦â€¦}
```

- æ·»åŠ  `Async` ï¼Œè®¾ç½®å¼‚æ­¥æ‰§è¡Œ
```java
@EnableAsync
@EnableScheduling
public class ChatBotSchedule {
	@Async
	@Scheduled(cron = "0/10 * * * * ?")  
	public void RunSchedule() {â€¦â€¦}

	@Async
	@Scheduled(cron = "0/20 * * * * ?")  
	public void RunSchedule2() {â€¦â€¦}
}
```

>[!warning] æ¨èåœ¨ä½¿ç”¨å¼‚æ­¥å¤šå®šæ—¶ä»»åŠ¡æ—¶ï¼Œé…ç½®ä¸€ä¸ª<u>ä¸“é—¨ç»™å¤šå®šæ—¶ä»»åŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ± </u>
>å› ä¸º SpringBoot é»˜è®¤çš„çº¿ç¨‹æ± ï¼Œåœ¨æ¯æ¬¡å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè¿™æ ·å°±ä¼šä¸æ–­åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œæµªè´¹èµ„æº

# â¤ åŠ¨æ€ä»»åŠ¡
>[!quote] åŠ¨æ€ä»»åŠ¡
> åŠ¨æ€ä»»åŠ¡ æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ å’Œç§»é™¤çš„å®šæ—¶ä»»åŠ¡ã€ä¸éœ€è¦é‡æ–°å¯åŠ¨åº”ç”¨ã€‘ï¼Œåªç”¨é€šè¿‡æ³¨å…¥ `TaskScheduler æ¥å£çš„å¯¹è±¡`ï¼Œè°ƒç”¨å®ƒçš„ `schedule æ–¹æ³•` å°±å¯ä»¥åŠ¨æ€åˆ›å»ºå’Œæ³¨å†Œæ–°çš„å®šæ—¶ä»»åŠ¡

## åŠ¨æ€ Cron
```java
@Component
public class DynamicTaskScheduler {

    @Autowired
    private TaskScheduler scheduler;

    private ScheduledFuture<?> currentTask;

    public void startDynamicTask(String cron) {
        // å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå–æ¶ˆå®ƒ
        if (currentTask != null && !currentTask.isCancelled()) {
            currentTask.cancel(true);
        }

        // è°ƒåº¦æ–°çš„ä»»åŠ¡
        scheduledFuture = scheduler.schedule(() -> {
            // æ‰§è¡ŒåŠ¨æ€å®šæ—¶ä»»åŠ¡çš„ä»£ç 
        }, new CronTrigger(cron));
    }
}

/**
 * åˆå§‹åŒ–
 */
@PostConstruct
private void init() {
	projectEndNotifyTask(
			messageNotifySettingConfig
					.getCronMap()
					.get(messageNotifySettingConfig.getProjectClosingCount())
	);
}
```

## åŠ¨æ€å»¶æ—¶ä»»åŠ¡
<u>æ‰§è¡Œé¡ºåº</u> ï¼š
* ç”Ÿæˆ scheduledFutureï¼šåœ¨è°ƒç”¨ scheduler.schedule(...) æ—¶ç«‹å³ç”Ÿæˆã€‚
* ç­‰å¾…å»¶è¿Ÿæ—¶é—´ï¼šæ ¹æ® delayInHours ç­‰å¾…ã€‚
* æ‰§è¡Œ executeTask()ï¼šåœ¨å»¶è¿Ÿæ—¶é—´åˆ°è¾¾åæ‰§è¡Œä»»åŠ¡ã€‚
* æ‰§è¡Œ cancelTask()ï¼šåœ¨ executeTask() æ‰§è¡Œå®Œæˆåè°ƒç”¨ï¼Œç”¨äºå–æ¶ˆè°ƒåº¦ï¼ˆæ­¤æ—¶ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼‰

```java
/**
 * å·¥æ—¶å®¡æ‰¹é€šçŸ¥å®šæ—¶ä»»åŠ¡
 */
@Configuration
public class WHApprovalNotifyTask {

    @Resource
    private WorkHourApprovalNotify workHourApprovalNotify;


    // å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨çš„çº¿ç¨‹æ•°ã€æœ‰ä¸€ä¸ªäººç™»è®°äº†å·¥æ—¶ï¼Œå°±è¦æœ‰ä¸€æ¬¡ä»»åŠ¡ã€‘
    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(50);
    // scheduledFutureè¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œç”¨äºå–æ¶ˆä»»åŠ¡æˆ–æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
    private ScheduledFuture<?> scheduledFuture;

    /**
     * å¼€å¯å®šæ—¶ä»»åŠ¡ï¼Œæœ‰äººç™»è®°å·¥æ—¶ï¼Œå°±è°ƒç”¨è¯¥æ–¹æ³•
     */
    public void scheduleTask(Integer delayInHours) {
        scheduledFuture = scheduler.schedule(
                () -> {
                    try {
                        executeTask();
                        cancelTask();
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                },
                // ä»»åŠ¡åœ¨delayInHourså°æ—¶åæ‰§è¡Œ
                delayInHours, TimeUnit.HOURS
        );
    }

    /**
     * æ‰§è¡Œä»»åŠ¡
     */
    private void executeTask() throws Exception {
        // ä»»åŠ¡é€»è¾‘
        workHourApprovalNotify.notifyByUserIds();
    }

    /**
     * å–æ¶ˆä»»åŠ¡
     */
    private void cancelTask() {
        if (scheduledFuture != null && !scheduledFuture.isCancelled()) {
            // false è¡¨ç¤ºå¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œä¸ä¸­æ–­å®ƒ
            scheduledFuture.cancel(false);
        }
    }

    @PostConstruct
    public void init() {
        scheduleTask(1);
    }
}
```











