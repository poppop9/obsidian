https://www.youtube.com/watch?v=eY9riN5Y2mQ&list=PL41m5U3u3wwkS8BU0fIeRQwY3hK4VlFlX&index=16


>[!quote] JPA 
>JPA ã€~~Java Persistence API~~ã€‘æ˜¯ä¸€ç§è§„èŒƒï¼Œå¯ä»¥çœ‹ä½œæ˜¯ JDBC çš„å‡çº§ç‰ˆã€‚JPA å°è£…äº† Hibernateï¼ŒHibernate é€šè¿‡ ORM å°† Java å¯¹è±¡æ˜ å°„åˆ°è¡¨ï¼Œå†é€šè¿‡ SQL æ¥æ“ä½œè¡¨

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

# å±‚æ¬¡ç»“æ„
![](https://s21.ax1x.com/2024/08/26/pAkPLWV.png)


# Entity
- **å®ä½“ç±»æ³¨è§£**
	- `@Entity` æ ‡è®°ä¸ºå®ä½“
	- `@Table` é…ç½®è¡¨
		- `name` æŒ‡å®šè¡¨å

---

- **å±æ€§æ³¨è§£**
	- `@Id` æŒ‡å®šä¸»é”®
	- `@GeneratedValue` æŒ‡å®šæŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦‚ä½•ç”Ÿæˆçš„
		- `strategy` 
			- `GenerationType.IDENTITY` è®©æ•°æ®åº“è‡ªå·±è‡ªå¢
			- `GenerationType.SEQUENCE` ä½¿ç”¨æ•°æ®åº“çš„åºåˆ—æ¥ç”Ÿæˆä¸»é”®å€¼
			- `GenerationType.UUID` æ ¹æ® UUID ç”Ÿæˆä¸»é”®å€¼
	- `@Column` é…ç½®åˆ—
		- `name` æŒ‡å®šåˆ—å

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name = "tb_customer")
public class Customer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "no")
    private Long no;
    @Column(name = "cust_name")
    private String custName;
    @Column(name = "cust_address")
    private String custAddress;
}

```

# â¤ï¸ JpaRepository
JpaRepository ä¸­æœ‰è®¸å¤šé»˜è®¤æ–¹æ³•ï¼Œ**ä¹Ÿå¯ä»¥åœ¨ç»§æ‰¿äº† JpaRepository çš„æ¥å£ä¸­è‡ªå®šä¹‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¼šæ ¹æ®æ–¹æ³•åè‡ªåŠ¨ç”Ÿæˆç›¸åº”æ¡ä»¶çš„ SQL è¯­å¥ï¼Œæ— éœ€é¢å¤–é…ç½®**

```java
// JpaRepository<å®ä½“åï¼Œä¸»é”®çš„æ•°æ®ç±»å‹>
public interface CustomerRepository extends JpaRepository<Customer, Long> {

    Customer save(Customer customer);

    /**
     * æŸ¥è¯¢æ¥å£
     */
    Optional<Customer> findById(Long id);

    List<Customer> findByCustName(String custName);
}
```

>[!hint] å¦‚æœä½ å®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿è‡ª `Repository` æ¥å£çš„è‡ªå®šä¹‰æ¥å£ï¼ŒSpring å®¹å™¨ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºè¿™ä¸ªæ¥å£çš„å®ä¾‹ï¼Œå¹¶æ³¨å…¥åˆ° IOC å®¹å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦åŠ  `@Repository` 

## ğŸ’› æ–°å¢ï¼Œä¿®æ”¹
- `save(å®ä½“å¯¹è±¡)` å¢æ”¹ï¼Œä½†æ˜¯ä¼šç­‰å¾…ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ï¼Œå…¶æ‰ä¼šå½±å“åˆ°æ•°æ®åº“
- `saveAll(é›†åˆ)` æ‰¹é‡å¢æ”¹
- `saveAndFlush(å®ä½“å¯¹è±¡)` å¢æ”¹ï¼Œå¹¶ç«‹å³æäº¤è¿™ä¸ªæ“ä½œ
- `saveAllAndFlush(é›†åˆ)` 

```java
// ä¸å¸¦ä¸»é”®ï¼Œå°±æ˜¯æ–°å¢
customerRepository.save(new Customer(null, 33L, "nelson", "France"));

// å¸¦ä¸»é”®ï¼Œå°±æ˜¯ä¿®æ”¹
customerRepository.save(new Customer(1L, 2L, "Kite", "Japen"));
```

```java
customerRepository.saveAllAndFlush(
		List.of(
				new Customer(null, 33L, "nelson", "France"),
				new Customer(null, 33L, "nelson", "France")
		)
);
```

## ğŸ’› æŸ¥
### æ¡ä»¶æŸ¥
- `findAll()` æ— æ¡ä»¶æŸ¥
- `findAll(Example æ¡ä»¶å¯¹è±¡)` 


- `findAllById(idé›†åˆ)` 


### æ’åºæŸ¥
- `findAll(Sort æ’åºå¯¹è±¡)` 


### é™åˆ¶æŸ¥
- `findAll(Limit é™åˆ¶å¯¹è±¡)` 



```java
/**
	æ¡ä»¶ + æ’åºæŸ¥
**/
// æ„é€ æ¡ä»¶
Example<Customer> example1 = Example.of(new Customer(null, 33L, null, null));  
// æ„é€ æ’åºè§„åˆ™
Sort sort = Sort.by("custName").descending();
customerRepository.findAll(example1, sort)  
        .forEach(System.out::println);
```

## ğŸ’› å…¶ä»–æ–¹æ³•
<u>åˆ¤æ–­æ˜¯å¦å­˜åœ¨</u> ï¼š
- `Boolean existsById(id)` çœ‹å¯¹åº” id çš„æ•°æ®æ˜¯å¦å­˜åœ¨
- `Boolean exists(Example æ¡ä»¶å¯¹è±¡)` å¤æ‚æ¡ä»¶æŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨

```java
System.out.println(customerRepository.existsById(1L));  
```

```java
// æ„å»ºæ¡ä»¶ï¼Œidä¸º1ï¼Œå¹¶ä¸”nameä¸ºKiteçš„æ•°æ®
Example<Customer> example = Example.of(new Customer(1L, null, "Kite", null));  

System.out.println(customerRepository.exists(example));  
```

---

<u>åˆ¤æ–­æ•°é‡</u> ï¼š
- `count()` 
- `count(Example æ¡ä»¶å¯¹è±¡)`

```java
long count = customerRepository.count();
System.out.println(count);
```




å½“ä½ åœ¨å®šä¹‰ `@Bean` æ³¨è§£çš„æ–¹æ³•å‚æ•°ä¸­ä½¿ç”¨ Repository æ¥å£æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨æ³¨å…¥ç›¸åº”çš„ Repository å®ä¾‹ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨è¿›è¡Œä¾èµ–æ³¨å…¥

# â¤ï¸ æ¼‚äº®çš„æ–¹æ³•å
[å…³é”®è¯](https://docs.spring.io/spring-data/jpa/reference/repositories/query-keywords-reference.html#appendix.query.method.subject)

## ğŸ’› æŸ¥
`find ç»“æœé™åˆ¶æ¡ä»¶ By æ¡ä»¶ Ignore å¿½ç•¥æ¡ä»¶ OrderBy æ’åºæ¡ä»¶`

<u>ç»“æœé™åˆ¶æ¡ä»¶</u> ï¼š
- `Distinct` é™åˆ¶ç»“æœä¸é‡å¤
- `First` 
- `One` ä¸æ¨èä½¿ç”¨ï¼Œå¦‚æœæ•°æ®è®°å½•æœ‰å¤šä¸ªï¼Œä¼šæŠ¥é”™
- `TopN` é™åˆ¶ç»“æœæ•°ä¸º N ä¸ª 

```java
findDistinctByName
```

<u>æ¡ä»¶åç§°</u> ï¼š

```java
// é¦–å…ˆä¼šå»Personç±»ä¸­æ‰¾addressZipCodeå±æ€§ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°ï¼Œé‚£å°± â€¦â€¦
// æ‰¾Personç±»ä¸­addresså±æ€§çš„å­å±æ€§zipCodeï¼Œç„¶åä½œä¸ºæ¡ä»¶
List<Person> findByAddressZipCode(ZipCode zipCode);
```


```java
// æ ¹æ®emailAddresså’Œlastnameå¿½ç•¥å¤§å°å†™çš„æŸ¥æ‰¾ï¼Œç»“æœå»é‡ï¼Œå¹¶æ ¹æ®Firstnameè¿›è¡Œå‡åºæ’åº
findDistinctByEmailAddressAndLastnameAllIgnoreCaseOrderByFirstnameAsc(EmailAddress emailAddress, String lastname)
```


# â¤ï¸ é«˜çº§ç‰¹æ€§
## ğŸ’› åŸºæ¥å£ Repository
ä½¿ç”¨åŸºæ¥å£ Repository å¯ä»¥å¤ç”¨æ–¹æ³•å

- å®šä¹‰åŸºæ¥å£
```java
@NoRepositoryBean
public interface BaseRepository<T> {
    List<T> findAllByCustName(String name);
}
```
- ç»§æ‰¿
```java
public interface CustomerRepository extends BaseRepository<Customer>, JpaRepository<Customer, Long> {
}
```

## ğŸ’› åˆ†é¡µ
- é™æ€æ–¹æ³•
	- `PageRequest of(ç¬¬å‡ é¡µï¼Œä¸€é¡µçš„å¤§å°ï¼ŒSort æ’åºå¯¹è±¡)` 

---

```java
public interface CustomerRepository  
        extends BaseRepository<Customer>, JpaRepository<Customer, Long> {
    Page<Customer> findAll(Pageable pageable);
}
```

```java
@Test
public void test_findAll_pageable() {
	// å®šä¹‰åˆ†é¡µå‚æ•°
	PageRequest pageRequest = PageRequest.of(  
        1,  
        5,  
        Sort.by("no").descending()  
	);
	Page<Customer> all = customerRepository.findAll(pageRequest);

	JsonNode jsonNode = objectMapper.valueToTree(all);
	System.out.println(jsonNode.toString());
}
```

## ğŸ’› è‡ªå®šä¹‰ sql
<u>åˆ æ”¹</u> ï¼š
https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html#jpa.modifying-queries

---

<u>æŸ¥</u> ï¼š
```java
public interface UserRepository extends JpaRepository<User, Long> {
	@Query("select u from User u where u.emailAddress = ?1")
	User findByEmailAddress(String emailAddress);
}
```

```java
// ä¼ å…¥çš„firstnameï¼Œlastnameå‚æ•°ä¼šè¢«æ³¨å…¥åˆ°sqlä¸­
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("select u from User u where u.firstname = :firstname or u.lastname = :lastname")
    User findByLastnameOrFirstname(String lastname, String firstname);
}
```

## æŸ¥è¯¢æ—¶æŠ“å–
>[!quote] æŠ“å–
>æŠ“å– æ˜¯ä»æ•°æ®åº“ä¸­è·å–å®ä½“ï¼ŒåŠå…¶å…³è”å±æ€§çš„æ•°æ®

<u>å®ä½“ç±»ä¸Š</u> ï¼š
-  `@NamedEntityGraph` åœ¨å®ä½“ç±»ä¸Šå®šä¹‰å®ä½“å›¾ï¼ŒæŒ‡å®šè¦æŠ“å–çš„å±æ€§
	- `name` æŒ‡å®šå®ä½“å›¾çš„åå­—
	- `attributeNodes` æŒ‡å®šæŠ“å–å“ªä¸ªå±æ€§

<u>ä»“å‚¨æ¥å£çš„æŸ¥è¯¢æ–¹æ³•ä¸Š</u> ï¼š
-  `@EntityGraph` åœ¨æŸ¥è¯¢æ–¹æ³•ä¸Šåº”ç”¨å®ä½“å›¾
    - `value`Â æŒ‡å®šå®ä½“å›¾çš„åå­—
    - `type`Â æŒ‡å®šæŠ“å–ç­–ç•¥
	    - FETCH ä»…æŠ“å–æŒ‡å®šçš„å±æ€§ï¼Œå…¶ä»–å±æ€§å°†ä½¿ç”¨é»˜è®¤çš„æ‡’åŠ è½½
	    - LOAD ä¸ä»…æŠ“å–æŒ‡å®šçš„å±æ€§ï¼Œè¿˜ä¼šæŠ“å–å…¶ä»–é»˜è®¤è®¾ç½®ä¸ºç«‹å³åŠ è½½çš„å±æ€§

### å¤ç”¨å®ä½“å›¾
**å¦‚æœæœ‰ä¸€ä¸ªå®ä½“å›¾éœ€è¦å¤ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶å®šä¹‰åœ¨ Entity ä¸Š**

- å®šä¹‰å‘½åå®ä½“å›¾
```java
@Entity
@NamedEntityGraph(name = "GroupInfo.detail", attributeNodes = @NamedAttributeNode("members"))
public class GroupInfo {
	@ManyToMany
	List<GroupMember> members = new ArrayList<GroupMember>();
	// é»˜è®¤æŠ“å–æ¨¡å¼æ˜¯æ‡’åŠ è½½ã€‚
}
```

- åœ¨æŸ¥è¯¢æ–¹æ³•ä¸­å¼•ç”¨å‘½åå®ä½“å›¾
```java
public interface GroupRepository extends CrudRepository<GroupInfo, String> {
  @EntityGraph(value = "GroupInfo.detail", type = EntityGraphType.LOAD)
  GroupInfo getByGroupName(String name);
}
```

### ä¸´æ—¶å®ä½“å›¾
**å¦‚æœæŸä¸ªå®ä½“å›¾ï¼Œåªåœ¨å½“å‰æŸ¥è¯¢æ–¹æ³•ä¸Šä½¿ç”¨ï¼Œé‚£å°±ç›´æ¥åœ¨å½“å‰æ–¹æ³•ä¸Šå®šä¹‰**

```java
public interface GroupRepository extends CrudRepository<GroupInfo, String> {
  @EntityGraph(attributePaths = { "members" })
  GroupInfo getByGroupName(String name);
}
```

---

é«˜çº§ç‰¹æ€§ï¼Œå¦‚åŠ¨æ€æŸ¥è¯¢ã€å¤šè¡¨æŸ¥è¯¢ã€åµŒå¥—æŸ¥è¯¢ã€å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°è°ƒç”¨ç­‰ã€‚ä¾‹å¦‚å¯ä»¥ä½¿ç”¨ Spring Data JPA æä¾›çš„å‘½åçº¦å®šæ¥è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢è¯­å¥ã€‚ä½¿ç”¨ Specification å¯¹è±¡æ¥å®ç°åŠ¨æ€æŸ¥è¯¢

åœ¨ Spring Data JPA ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ Spring Cache æ¥å®ç°ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨ HikariCP æ¥å®ç°1æ•°æ®åº“è¿æ¥æ± é…ç½®ç­‰

Another option is putting your query inside the database and then using either Spring Data JPAâ€™s @StoredProcedure annotation or if itâ€™s a database function using the @Query annotation and invoking it with a CALL.
















